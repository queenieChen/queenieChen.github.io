<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"queeniechen.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="我叫小白，初来乍到，请多指教~">
<meta property="og:type" content="website">
<meta property="og:title" content="Queenie Chen">
<meta property="og:url" content="https://queeniechen.github.io/index.html">
<meta property="og:site_name" content="Queenie Chen">
<meta property="og:description" content="我叫小白，初来乍到，请多指教~">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Queenie Chen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://queeniechen.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Queenie Chen</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Queenie Chen</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">三十功名尘与土，八千里路云和月</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2021/01/24/90-Linux%E9%A9%B1%E5%8A%A8%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/24/90-Linux%E9%A9%B1%E5%8A%A8%E4%B8%80/" class="post-title-link" itemprop="url">linux驱动一</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-24 12:20:30" itemprop="dateCreated datePublished" datetime="2021-01-24T12:20:30+08:00">2021-01-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是驱动"><a href="#什么是驱动" class="headerlink" title="什么是驱动"></a>什么是驱动</h1><p>所谓驱动，指的是一套code，它可以操作硬件，使硬件处于某种工作模式下。</p>
<h2 id="驱动的地位"><a href="#驱动的地位" class="headerlink" title="驱动的地位"></a>驱动的地位</h2><p>驱动是连接内核和设备的桥梁。</p>
<p>从上往下看，我们上层是user层，即应用层，这一层放着应用程序，是对设备的操作设置，比如使gpio接口输出高电平。</p>
<p>中间一层是内核层，提供了设备管理功能，管理着驱动程序。来自应用层的操作首先调用了内核层的系统调用，进入内核态，由内核代替应用程序来执行，调用驱动程序。</p>
<p>中间层的驱动对最后一层的设备进行驱动。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app: open read write</span><br><span class="line"></span><br><span class="line">kernel: sys_open sys_read sys_write</span><br><span class="line"></span><br><span class="line">drv_open drv_read drv_write</span><br></pre></td></tr></table></figure>
<h2 id="应用到驱动的过程"><a href="#应用到驱动的过程" class="headerlink" title="应用到驱动的过程"></a>应用到驱动的过程</h2><p>app层，调用open函数打开文件/dev/xxx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m &#x3D; open(&quot;&#x2F;dev&#x2F;xxx&quot;,flags,mode)</span><br></pre></td></tr></table></figure>

<p>kernel层，上面获取的整数m对内核中的结构体struct file. 打开文件时会传入flags和mode，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct file&#123;</span><br><span class="line">const struct file_operations *f_op;</span><br><span class="line"></span><br><span class="line">unsigned int f_flags;</span><br><span class="line">fmode_t f_mode;</span><br></pre></td></tr></table></figure>

<p>根据主设备好，调用结构体struct file_operations * f_op 中有open，read，write，ioctrl成员</p>
<h1 id="如何写驱动程序"><a href="#如何写驱动程序" class="headerlink" title="如何写驱动程序"></a>如何写驱动程序</h1><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li>确定主设备号（应用程序根据主设备号在一堆驱动里面找）</li>
<li>定义自己的文件操作结构体file_operations</li>
<li>实现对应的open/read/write等函数（drv_open等），填入文件操作结构体</li>
<li>把文件操作结构体告诉内核：注册驱动程序（register_chrdev(主设备号，操作结构体)）</li>
<li>通过入口函数来调用注册驱动程序</li>
<li>通过出口函数来卸载驱动程序(unregister_chrdev())</li>
<li>提供设备信息，自动创建设备节点</li>
</ol>
<h2 id="实例hello"><a href="#实例hello" class="headerlink" title="实例hello"></a>实例hello</h2><p>首先写驱动文件hello_drv.c<br>1.头文件<br>2.主设备号为0，表示系统默认分配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static int major &#x3D; 0;</span><br></pre></td></tr></table></figure>

<p>定义一块buf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static char kernel_buf[1024];</span><br></pre></td></tr></table></figure>
<p>定义宏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define MIN(a,b) (a &lt; b ? a : b)</span><br></pre></td></tr></table></figure>
<p>定义类<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static struct class *hello_class;</span><br></pre></td></tr></table></figure></p>
<p>3.实现对应的open等函数，填入file_operations结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; __user 表示这块buf来自用户空间，不可以直接访问</span><br><span class="line">static ssize_t hello_drv_read(struct file *file,char __user * buf,size_t size, loff_t *offset)&#123;</span><br><span class="line">    printk(&quot;%s %s line %d\n&quot;,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    copy_to_user(buf,kernel_buf,MIN(1024,size));&#x2F;&#x2F;从kernel中读取buf给user,拷贝的长度为MIN(1024,size)</span><br><span class="line">    return MIN(1024,size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static ssize_t hello_drv_write(struct file *file,char __user * buf,size_t size, loff_t *offset)&#123;</span><br><span class="line">    printk(&quot;%s %s line %d\n&quot;,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    copy_from_user(kernel_buf,buf,MIN(1024,size));&#x2F;&#x2F;从user中拷贝buf到kernel</span><br><span class="line">    return MIN(1024,size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static int hello_drv_open(struct inode *node,struct file *file)&#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static int hello_drv_close(struct inode *node,struct file *file)&#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.定义file_operations结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static struct file_operations hello_drv &#x3D; &#123;</span><br><span class="line">    .owner &#x3D; THIS_MODULE,</span><br><span class="line">    .open &#x3D; hello_drv_open,</span><br><span class="line">    .read &#x3D; hello_drv_read,</span><br><span class="line">    .write &#x3D; hello_drv_write,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>5.入口函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static int __init hello_init(void)&#123;</span><br><span class="line">    major &#x3D; register_chrdev(0,&quot;hello&quot;,&amp;hello_drv);&#x2F;&#x2F;  设备节点 &#x2F;dev&#x2F;hello</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;创建class</span><br><span class="line">    hello_class &#x3D; class_create(THIS_MODULE,&quot;hello_class&quot;);</span><br><span class="line">    err &#x3D; PTR_ERR(hello_class);</span><br><span class="line">    if(IS_ERR(hello_class))&#123;</span><br><span class="line">        unregister_chrdev(major,&quot;hello&quot;);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;创建device</span><br><span class="line">    device_create(hello_class,NULL,MXDEV(major,0),NULL,&quot;hello&quot;);&#x2F;&#x2F;主设备号是major,次设备号是0</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6.出口函数，没有返回值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static void __exit hello_exit(void)&#123;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;销毁设备</span><br><span class="line">    device_destroy(hello_class,MXDEV(major,0));</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;销毁类</span><br><span class="line">    class_destroy(hello_class);</span><br><span class="line">    major &#x3D; unregister_chrdev(0,&quot;hello&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>7.其他</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);&#x2F;&#x2F;linux内核遵循GPL协议</span><br></pre></td></tr></table></figure>

<p>开始写测试程序hello_drv_test.c：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;头文件</span><br><span class="line"></span><br><span class="line">int main(int argc,char **argv)&#123;</span><br><span class="line">    int fd;</span><br><span class="line">    char buf[1024];</span><br><span class="line">    int len;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;判断参数</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;打开文件</span><br><span class="line">    fd &#x3D; open(&quot;&#x2F;dev&#x2F;hello&quot;,O_RDWR);</span><br><span class="line">    if(fd&#x3D;&#x3D;-1)</span><br><span class="line">    &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;写文件或读文件</span><br><span class="line">    if((0&#x3D;&#x3D;strcmp(argv[1],&quot;-w&quot;)) &amp;&amp; (argv &#x3D;&#x3D; 3))</span><br><span class="line">    &#123;</span><br><span class="line">        len &#x3D; strlen(argv[2])+1;</span><br><span class="line">        len &#x3D; len &lt; 1024 ? len :1024;</span><br><span class="line">        write(fd,argv[2],len);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        len &#x3D; read(fd,buf,1024);</span><br><span class="line">        buf[1023] &#x3D; &#39;\0&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    close(fd);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">KERN_DIR &#x3D; &#x2F;****linux-4.4</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">    make -C $(KERN_DIR) M&#x3D;&#39;pwd&#39; modules</span><br><span class="line">    $(CROSS_COMPILE) gcc -o hello_drv_test hello_drv_test.c</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> clean:</span><br><span class="line">    make -C $(KERN_DIR) M&#x3D;&#39;pwd&#39; modules clean</span><br><span class="line">    rm -rf modules.order</span><br><span class="line">    rm -rf hello_drv_test</span><br><span class="line"> </span><br><span class="line"> obj-m +&#x3D; hello_drv.o</span><br></pre></td></tr></table></figure>



<h1 id="Linux支持3种设备"><a href="#Linux支持3种设备" class="headerlink" title="Linux支持3种设备"></a>Linux支持3种设备</h1><ul>
<li>字符设备（charactor）：字节流接口</li>
<li>块设备（block）：存放文件系统；处理多字节数据块IO</li>
<li>网络接口（network）：通过网络传输数据包</li>
</ul>
<h1 id="设备驱动API"><a href="#设备驱动API" class="headerlink" title="设备驱动API"></a>设备驱动API</h1><p>Linux驱动API属于事件驱动类型：只有当某件事情发生，驱动代码才执行。</p>
<p>Linux设备生命周期：<br>module_init：模块加载<br>module_exit：模块卸载</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/26/30-Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/26/30-Python/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-26 11:03:59 / 修改时间：11:40:52" itemprop="dateCreated datePublished" datetime="2020-12-26T11:03:59+08:00">2020-12-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h2 id="title-python"><a href="#title-python" class="headerlink" title="title :python"></a>title :python</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">x &#x3D; input()</span><br><span class="line">b &#x3D; x.split()</span><br><span class="line">a &#x3D; len(x)</span><br><span class="line">print(x[0]);</span><br><span class="line"></span><br><span class="line">若x&#x3D;&#39;abc&#39;</span><br><span class="line">那么x[0]&#x3D;&#39;a&#39;  x[1]&#x3D;&#39;b&#39;  x[2]&#x3D;&#39;c&#39;</span><br><span class="line">x[-1]&#x3D;&#39;c&#39;  x[-2]&#x3D;&#39;b&#39;   x[-3]&#x3D;&#39;a&#39;</span><br><span class="line">len(x)&#x3D;3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 计算字符串最后一个单词的长度，单词以空格隔开。</span><br><span class="line">x &#x3D; input()</span><br><span class="line">print(len(x.split()[-1]));</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">写出一个程序，接受一个由字母、数字和空格组成的字符串，和一个字母，然后输出输入字符串中该字母的出现次数。不区分大小写。</span><br><span class="line">x &#x3D; input().lower()</span><br><span class="line">y &#x3D; input().lower()</span><br><span class="line">print(x.count(y))</span><br></pre></td></tr></table></figure>













      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/13/power-hint/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/power-hint/" class="post-title-link" itemprop="url">power hint机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 21:25:33" itemprop="dateCreated datePublished" datetime="2020-12-13T21:25:33+08:00">2020-12-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h1><p>这里camera场景指camera执行的不同阶段，比如open ,preview, take picture.  不同场景对camera性能和功耗要求不一样，比如open时想要快速，必须提频，此时功耗也就高了。如何设置调节策略使得各场景既能达到想要的反应速度，流畅水平，又使得能耗消耗在预期水平？由此引入power hint 机制。</p>
<p>总结一下：性能和功耗平衡需要策略</p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>不同的平台软、硬件配置不一样，性能不同，那么策略也有所不同。这里分为3个等级，分别是performance, normal, low power。</p>
<table>
<thead>
<tr>
<th>Power scene</th>
<th>CPU DVFS，</th>
<th>Thermal</th>
<th>DDR DFS</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Performance</strong></td>
<td>Generally，at least 4 CPU online &amp; Freq is veryhigh</td>
<td>Disable</td>
<td>Very  high/Normal</td>
</tr>
<tr>
<td><strong>Normal</strong></td>
<td>Default</td>
<td>Enable</td>
<td>Very high/Normal/Low</td>
</tr>
<tr>
<td><strong>Low power</strong></td>
<td>Some  projects have cpu hotplug &amp; Increase the proportion of running low Freq</td>
<td>Enable</td>
<td>Very  high//Normal/Low</td>
</tr>
</tbody></table>
<ol>
<li>performance：<br> 1）通常，至少4个cpu online，cpu freq很高<br> 2）拔核策略disable<br> 3）ddr dfs为high或者normal</li>
<li>normal：<br> 1）cpu频点默认<br> 2）拔核策略enable<br> 3）ddr dfs：high/normal/low</li>
<li>low power：<br> 1)增加跑低频的概率<br> 2)拔核策略enable<br> 3)ddr dfs：high/normal/low</li>
</ol>
<p>##1.1 hal3_2v1<br>对于open camera, close camera, stop preview(flush)，走的都是perforemance等级，ddr dfs走normal即可。</p>
<p>take picture走performance，ddr dfs走high。</p>
<p>recording走low power,ddr dfs也是normal。</p>
<p>普通预览走low power,ddr dfs也是low。</p>
<p>bokeh预览走normal，ddr dfs也是normal。</p>
<table>
<thead>
<tr>
<th>Power scene</th>
<th>CPU DVFS，</th>
<th>Thermal</th>
<th>DDR DFS</th>
<th>Camera  scene</th>
</tr>
</thead>
<tbody><tr>
<td>Performance</td>
<td>Generally，at least 4 CPU online  &amp;  Freq is veryhigh</td>
<td>Disable</td>
<td>normal</td>
<td>Open/close  Camera，stop preview (flush)</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Very High</td>
<td>Take  picture</td>
</tr>
<tr>
<td>Normal</td>
<td>Default</td>
<td>Enable</td>
<td>Normal</td>
<td>Preview  with Blu /Bokeh/Panorama</td>
</tr>
<tr>
<td>Low power</td>
<td>Some  projects have cpu hotplug /Increase the proportion of running low Freq</td>
<td>Enable</td>
<td>Normal</td>
<td>Recording</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Low</td>
<td>preview  under normal scene</td>
</tr>
</tbody></table>
<p><img src="1.png" alt="img"></p>
<p>##1.2 hal3_2v4</p>
<table>
<thead>
<tr>
<th>Power scene</th>
<th>CPU DVFS，</th>
<th>DDR DFS</th>
<th>Camera  scene</th>
</tr>
</thead>
<tbody><tr>
<td>Performance</td>
<td>Generally，at least 4 CPU online  &amp;  Freq is veryhigh</td>
<td>Normal（as default is Very high）</td>
<td>Open /close  Camera，</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Very high</td>
<td>Take  picture</td>
</tr>
<tr>
<td>Normal</td>
<td>Default</td>
<td>Normal （as default is Very high）</td>
<td>NULL</td>
</tr>
<tr>
<td>Low power</td>
<td>Just  Increase the proportion of running low Freq</td>
<td>Very high</td>
<td>Preview /  recording</td>
</tr>
</tbody></table>
<p><img src="2.png" alt="img"></p>
<h1 id="2-如何实现？"><a href="#2-如何实现？" class="headerlink" title="2. 如何实现？"></a>2. 如何实现？</h1><h2 id="2-1-怎么选择策略？"><a href="#2-1-怎么选择策略？" class="headerlink" title="2.1 怎么选择策略？"></a>2.1 怎么选择策略？</h2><p>各场景根据需要从如下的结构体中选择对应的策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef enum CAMERA_PERFORMACE_SCENE &#123;</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_1 &#x3D; 1,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_2,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_3,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_4,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_5,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_6,</span><br><span class="line">    CAM_PERFORMNCE_LEVEL_MAX</span><br><span class="line">&#125; sys_performance_camera_scene;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-1-setCamPreformaceScene"><a href="#2-1-1-setCamPreformaceScene" class="headerlink" title="2.1.1 setCamPreformaceScene"></a>2.1.1 setCamPreformaceScene</h3><p>问题来了，谁来选这个策略？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">void SprdCameraSystemPerformance::setCamPreformaceScene(</span><br><span class="line">    sys_performance_camera_scene camera_scene) &#123;</span><br><span class="line">    Mutex::Autolock l(&amp;mLock);</span><br><span class="line">#ifndef CONFIG_CAMERA_DFS_FIXED_MAXLEVEL</span><br><span class="line">    switch (camera_scene) &#123;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_6:</span><br><span class="line">        setPowerHint(CAM_POWER_PERFORMACE_ON);</span><br><span class="line">        changeDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_5:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_4:</span><br><span class="line">        setPowerHint(CAM_POWER_NORMAL);</span><br><span class="line">        changeDfsPolicy(CAM_NORMAL);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_3:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_2:</span><br><span class="line">        setPowerHint(CAM_POWER_LOWPOWER_ON);</span><br><span class="line">        changeDfsPolicy(CAM_NORMAL);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_1:</span><br><span class="line">        setPowerHint(CAM_POWER_LOWPOWER_ON);</span><br><span class="line">        changeDfsPolicy(CAM_LOW);</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGI(&quot;camera scene not support&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">#else</span><br><span class="line">#if (CONFIG_CAMERA_DFS_FIXED_MAXLEVEL &#x3D;&#x3D; 3)</span><br><span class="line">    changeDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">#elif(CONFIG_CAMERA_DFS_FIXED_MAXLEVEL &#x3D;&#x3D; 2)</span><br><span class="line">    changeDfsPolicy(CAM_NORMAL);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    switch (camera_scene) &#123;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_6:</span><br><span class="line">        setPowerHint(CAM_POWER_PERFORMACE_ON);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_5:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_4:</span><br><span class="line">        setPowerHint(CAM_POWER_NORMAL);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_3:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_2:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_1:</span><br><span class="line">        setPowerHint(CAM_POWER_LOWPOWER_ON);</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGI(&quot;camera scene not support&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    mCurrentPowerHintScene &#x3D; camera_scene;</span><br><span class="line"></span><br><span class="line">    HAL_LOGD(&quot;x camera scene:%d&quot;, camera_scene);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又有2个问题，通过给函数setCamPreformaceScene传入具体参数camera_scene来选择策略，那么</p>
<ol>
<li>选择策略后，又是如何实现策略实施的呢？</li>
<li>谁给setCamPreformaceScene传的这个参数？</li>
</ol>
<h2 id="2-2-策略如何实施？"><a href="#2-2-策略如何实施？" class="headerlink" title="2.2 策略如何实施？"></a>2.2 策略如何实施？</h2><p>在setCamPreformaceScene这个函数体的实现中可以看到，根据不同配置有不同的策略方案。主要是：</p>
<ol>
<li>int SprdCameraSystemPerformance::changeDfsPolicy(dfs_policy_t dfs_policy)这个是来选择ddr dfs策略的</li>
<li>void SprdCameraSystemPerformance::setPowerHint(power_hint_state_type_t powerhint_id)这个是设置power hint的等级的</li>
</ol>
<p>ddr dfs等级结构体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef enum DFS_POLICY &#123;</span><br><span class="line">    CAM_EXIT,</span><br><span class="line">    CAM_LOW,</span><br><span class="line">    CAM_NORMAL,</span><br><span class="line">    CAM_VERYHIGH,</span><br><span class="line">&#125; dfs_policy_t;</span><br></pre></td></tr></table></figure>

<p>power scene结构体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef enum CURRENT_POWER_HINT &#123;</span><br><span class="line">    CAM_POWER_NORMAL,</span><br><span class="line">    CAM_POWER_PERFORMACE_ON,</span><br><span class="line">    CAM_POWER_PERFORMACE_ON</span><br><span class="line">&#125; power_hint_state_type_t;</span><br></pre></td></tr></table></figure>
<p>现在结构体是不是有点混乱？我们来理一理：<br>power_hint_state_type_t总共3个档次，对应之前说的NORMAL，PERFORMACE和PERFORMACE这3种策略。从表格中可以看出，不同的camera scene除了要选刚刚3种策略外，还要选中ddr dfs策略（这里dfs_policy_t有4档）。所以，由于cpu dvfs和ddr dfs都要选中，于是sys_performance_camera_scene就配出了多个来，这里是7个。实际代码实现顺序是先传camera_scene这个参数，再去适配cpu dvfs和ddr dfs。</p>
<h3 id="2-2-1-changeDfsPolicy"><a href="#2-2-1-changeDfsPolicy" class="headerlink" title="2.2.1 changeDfsPolicy"></a>2.2.1 changeDfsPolicy</h3><p>changeDfsPolicy这个函数是用来实现dfs_policy的选择的，当dfs_policy为CAM_EXIT时，根据当前dfs策略进行releaseDfsPolicy（mCameraDfsPolicyCur），设置完后将mCameraDfsPolicyCur = CAM_EXIT；当dfs_policyCAM_LOW时，setDfsPolicy（CAM_LOW），并且根据当前mCameraDfsPolicyCur来选择releaseDfsPolicy（）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">int SprdCameraSystemPerformance::changeDfsPolicy(dfs_policy_t dfs_policy) &#123;</span><br><span class="line"></span><br><span class="line">    switch (dfs_policy) &#123;</span><br><span class="line">    case CAM_EXIT:</span><br><span class="line">        if (CAM_LOW &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            releaseDfsPolicy(CAM_LOW);</span><br><span class="line">        &#125; else if (CAM_NORMAL &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            releaseDfsPolicy(CAM_NORMAL);</span><br><span class="line">        &#125; else if (CAM_VERYHIGH &#x3D;&#x3D; mCameraDfsPolicyCur)</span><br><span class="line">            releaseDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        mCameraDfsPolicyCur &#x3D; CAM_EXIT;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_LOW:</span><br><span class="line">        if (CAM_EXIT &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_LOW);</span><br><span class="line">        &#125; else if (CAM_NORMAL &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_LOW);</span><br><span class="line">            releaseDfsPolicy(CAM_NORMAL);</span><br><span class="line">        &#125; else if (CAM_VERYHIGH &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_LOW);</span><br><span class="line">            releaseDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        &#125;</span><br><span class="line">        mCameraDfsPolicyCur &#x3D; CAM_LOW;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_NORMAL:</span><br><span class="line">        if (CAM_EXIT &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_NORMAL);</span><br><span class="line">        &#125; else if (CAM_LOW &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_NORMAL);</span><br><span class="line">            releaseDfsPolicy(CAM_LOW);</span><br><span class="line">        &#125; else if (CAM_VERYHIGH &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_NORMAL);</span><br><span class="line">            releaseDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        &#125;</span><br><span class="line">        mCameraDfsPolicyCur &#x3D; CAM_NORMAL;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_VERYHIGH:</span><br><span class="line">        if (CAM_EXIT &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        &#125; else if (CAM_LOW &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">            releaseDfsPolicy(CAM_LOW);</span><br><span class="line">        &#125; else if (CAM_NORMAL &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">            releaseDfsPolicy(CAM_NORMAL);</span><br><span class="line">        &#125;</span><br><span class="line">        mCameraDfsPolicyCur &#x3D; CAM_VERYHIGH;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGW(&quot;unrecognize dfs policy&quot;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_LOGD(&quot;mCameraDfsPolicyCur: %d&quot;, mCameraDfsPolicyCur);</span><br><span class="line"></span><br><span class="line">    return NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-1-releaseDfsPolicy"><a href="#2-2-1-1-releaseDfsPolicy" class="headerlink" title="2.2.1.1 releaseDfsPolicy"></a>2.2.1.1 releaseDfsPolicy</h4><p>在releaseDfsPolicy（）这个函数里，根据不同的dfs_policy，设置dfs_scene值，并将其写入文件节点exit_scene</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">int SprdCameraSystemPerformance::releaseDfsPolicy(int dfs_policy) &#123;</span><br><span class="line"></span><br><span class="line">    const char *dfs_scene &#x3D; NULL;</span><br><span class="line">    const char *const scenario_dfs &#x3D;</span><br><span class="line">        &quot;&#x2F;sys&#x2F;class&#x2F;devfreq&#x2F;scene-frequency&#x2F;sprd_governor&#x2F;exit_scene&quot;;</span><br><span class="line">    FILE *fp &#x3D; fopen(scenario_dfs, &quot;wb&quot;);</span><br><span class="line">    if (NULL &#x3D;&#x3D; fp) &#123;</span><br><span class="line">        HAL_LOGW(&quot;failed to open %s X&quot;, scenario_dfs);</span><br><span class="line">        return BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch (dfs_policy) &#123;</span><br><span class="line">    case CAM_LOW:</span><br><span class="line">        dfs_scene &#x3D; CAM_LOW_STR;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_NORMAL:</span><br><span class="line">        dfs_scene &#x3D; CAM_NORMAL_STR;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_VERYHIGH:</span><br><span class="line">        dfs_scene &#x3D; CAM_VERYHIGH_STR;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGW(&quot;unrecognize dfs policy&quot;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_LOGD(&quot;release dfs_scene: %s&quot;, dfs_scene);</span><br><span class="line">    &#x2F;&#x2F; echo dfs_scene &gt; scenario_dfs</span><br><span class="line">    fprintf(fp, &quot;%s&quot;, dfs_scene);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    fp &#x3D; NULL;</span><br><span class="line">    return NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-2-setDfsPolicy"><a href="#2-2-1-2-setDfsPolicy" class="headerlink" title="2.2.1.2 setDfsPolicy"></a>2.2.1.2 setDfsPolicy</h4><p>在 setDfsPolicy（）这个函数里，根据不同的dfs_policy，设置dfs_scene值，并将其写入文件节点scenario_dfs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">int SprdCameraSystemPerformance::setDfsPolicy(int dfs_policy) &#123;</span><br><span class="line"></span><br><span class="line">    const char *dfs_scene &#x3D; NULL;</span><br><span class="line">    const char *const scenario_dfs &#x3D;</span><br><span class="line">        &quot;&#x2F;sys&#x2F;class&#x2F;devfreq&#x2F;scene-frequency&#x2F;sprd_governor&#x2F;scenario_dfs&quot;;</span><br><span class="line">    FILE *fp &#x3D; fopen(scenario_dfs, &quot;wb&quot;);</span><br><span class="line">    if (NULL &#x3D;&#x3D; fp) &#123;</span><br><span class="line">        HAL_LOGW(&quot;failed to open %s X&quot;, scenario_dfs);</span><br><span class="line">        return BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    switch (dfs_policy) &#123;</span><br><span class="line">    case CAM_LOW:</span><br><span class="line">        dfs_scene &#x3D; CAM_LOW_STR;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_NORMAL:</span><br><span class="line">        dfs_scene &#x3D; CAM_NORMAL_STR;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_VERYHIGH:</span><br><span class="line">        dfs_scene &#x3D; CAM_VERYHIGH_STR;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGW(&quot;unrecognize dfs policy&quot;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_LOGD(&quot;dfs_scene: %s&quot;, dfs_scene);</span><br><span class="line">    &#x2F;&#x2F; echo dfs_scene &gt; scenario_dfs</span><br><span class="line">    fprintf(fp, &quot;%s&quot;, dfs_scene);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    fp &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">    return NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-2-setPowerHint"><a href="#2-2-2-setPowerHint" class="headerlink" title="2.2.2 setPowerHint"></a>2.2.2 setPowerHint</h3><p>setPowerHint函数的实现，首先要考虑和判断当前powerhint策略。例如要设置成CAM_POWER_PERFORMACE_ON，而当前已经是CAM_POWER_PERFORMACE_ON了，就无需多做什么了。若当前策略为CAM_POWER_NORMAL，而目标等级CAM_POWER_PERFORMACE_ON，则</p>
<p>1）acquirePowerHint</p>
<p>2）重新设置mCurrentPowerHint</p>
<p>当前策略不是CAM_POWER_NORMAL时，而策略有变化时，需要先releasePowerHint当前策略，再获取策略，置状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">void SprdCameraSystemPerformance::setPowerHint(</span><br><span class="line">    power_hint_state_type_t powerhint_id) &#123;</span><br><span class="line"></span><br><span class="line">    if (!mPowermanageInited) &#123;</span><br><span class="line">        HAL_LOGE(&quot;need init.&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_LOGD(&quot;IN, mCurrentPowerHint&#x3D;%d&quot;, mCurrentPowerHint);</span><br><span class="line"></span><br><span class="line">#if (CONFIG_HAS_CAMERA_HINTS_VERSION &#x3D;&#x3D; ANDROID_VERSION_P)</span><br><span class="line">    switch (mCurrentPowerHint) &#123;</span><br><span class="line">    case CAM_POWER_NORMAL:</span><br><span class="line">        if (powerhint_id &#x3D;&#x3D; CAM_POWER_PERFORMACE_ON) &#123;</span><br><span class="line">            &#x2F;&#x2F; thermalEnabled(false);</span><br><span class="line">            acquirePowerHint(mScenePerformance);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_PERFORMACE_ON;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_LOWPOWER_ON) &#123;</span><br><span class="line">            acquirePowerHint(mSceneLowPower);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_LOWPOWER_ON;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_NORMAL) &#123;</span><br><span class="line">            HAL_LOGD(&quot;current power state is already CAM_POWER_NORMAL,&quot;</span><br><span class="line">                     &quot;state are both 0, just return&quot;);</span><br><span class="line">            goto exit;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_POWER_PERFORMACE_ON:</span><br><span class="line">        if (powerhint_id &#x3D;&#x3D; CAM_POWER_PERFORMACE_ON) &#123;</span><br><span class="line">            HAL_LOGD(&quot;current power state is already CAM_POWER_PERFORMACE_ON,&quot;</span><br><span class="line">                     &quot;state are both 1, just return&quot;);</span><br><span class="line">            goto exit;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_LOWPOWER_ON) &#123;</span><br><span class="line">            releasePowerHint(mScenePerformance);</span><br><span class="line">            acquirePowerHint(mSceneLowPower);</span><br><span class="line">            &#x2F;&#x2F; thermalEnabled(true);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_LOWPOWER_ON;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_NORMAL) &#123;</span><br><span class="line">            releasePowerHint(mScenePerformance);</span><br><span class="line">            &#x2F;&#x2F; thermalEnabled(true);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_NORMAL;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_POWER_LOWPOWER_ON:</span><br><span class="line">        if (powerhint_id &#x3D;&#x3D; CAM_POWER_PERFORMACE_ON) &#123;</span><br><span class="line">            &#x2F;&#x2F; thermalEnabled(false);</span><br><span class="line">            releasePowerHint(mSceneLowPower);</span><br><span class="line">            acquirePowerHint(mScenePerformance);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_PERFORMACE_ON;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_LOWPOWER_ON) &#123;</span><br><span class="line">            HAL_LOGD(&quot;current power state is already CAM_POWER_LOWPOWER_ON,&quot;</span><br><span class="line">                     &quot;state are both 0, just return&quot;);</span><br><span class="line">            goto exit;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_NORMAL) &#123;</span><br><span class="line">            releasePowerHint(mSceneLowPower);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_NORMAL;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGE(&quot;should not be here&quot;);</span><br><span class="line">        goto exit;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">exit:</span><br><span class="line">    HAL_LOGD(&quot;out, mCurrentPowerHint&#x3D;%d&quot;, mCurrentPowerHint);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-2-1acquirePowerHint"><a href="#2-2-2-1acquirePowerHint" class="headerlink" title="2.2.2.1acquirePowerHint"></a>2.2.2.1acquirePowerHint</h4><p>acquirePowerHint主要由acquire()实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#if (CONFIG_HAS_CAMERA_HINTS_VERSION &#x3D;&#x3D; ANDROID_VERSION_P)</span><br><span class="line">void SprdCameraSystemPerformance::acquirePowerHint(</span><br><span class="line">    ::android::sp&lt;::android::PowerHintScene&gt; mScene) &#123;</span><br><span class="line"></span><br><span class="line">    if (mScene !&#x3D; NULL) &#123;</span><br><span class="line">        mScene-&gt;acquire();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-2-releasePowerHint"><a href="#2-2-2-2-releasePowerHint" class="headerlink" title="2.2.2.2 releasePowerHint"></a>2.2.2.2 releasePowerHint</h4><p>releasePowerHint主要由release()实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void SprdCameraSystemPerformance::releasePowerHint(</span><br><span class="line">    ::android::sp&lt;::android::PowerHintScene&gt; mScene) &#123;</span><br><span class="line"></span><br><span class="line">    if (mScene !&#x3D; NULL) &#123;</span><br><span class="line">        mScene-&gt;release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="谁来选择策略？"><a href="#谁来选择策略？" class="headerlink" title="谁来选择策略？"></a>谁来选择策略？</h2><p>我们来看看哪些地方调用了setCamPreformaceScene：</p>
<ol>
<li><p>关闭相机的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int SprdCamera3HWI::closeCamera() &#123;</span><br><span class="line">mOEMIf-&gt;setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>切换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int SprdCamera3HWI::flush() &#123;</span><br><span class="line">    if (mOEMIf) &#123;</span><br><span class="line">        mOEMIf-&gt;setFlushFlag(1);</span><br><span class="line">        mOEMIf-&gt;setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int SprdCamera3OEMIf::start(camera_channel_type_t channel_type,</span><br><span class="line">                            uint32_t frame_number) &#123;</span><br><span class="line">	setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自动对焦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">status_t SprdCamera3OEMIf::autoFocus() &#123;</span><br><span class="line">    if (mSysPerformace) &#123;</span><br><span class="line">        mGetLastPowerHint &#x3D; mSysPerformace-&gt;mCurrentPowerHintScene;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接收预览帧时，根据预览流，当时的模式选择不同的档次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void SprdCamera3OEMIf::receivePreviewFrame(struct camera_frame_type *frame) &#123;</span><br><span class="line">	if (pre_stream) &#123;</span><br><span class="line">		if (!isCapturing() &amp;&amp; mIsPowerhintWait &amp;&amp; !mIsAutoFocus) &#123;</span><br><span class="line">			if ((frame_num &gt; mStartFrameNum) &amp;&amp;(frame_num - 						mStartFrameNum &gt; CAM_POWERHINT_WAIT_COUNT)) &#123;</span><br><span class="line">				if (getMultiCameraMode() &#x3D;&#x3D; MODE_BLUR ||</span><br><span class="line">                    getMultiCameraMode() &#x3D;&#x3D; MODE_BOKEH ||</span><br><span class="line">                    mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_PANORAMA ||</span><br><span class="line">                    mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_3DNR_PHOTO ||</span><br><span class="line">                    mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_FILTER ||</span><br><span class="line">                    mSprdAppmodeId &#x3D;&#x3D; -1 ||</span><br><span class="line">                    (mRecordingMode &amp;&amp; !mVideoWidth &amp;&amp; !mVideoHeight))&#123;</span><br><span class="line">                    setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_4);</span><br><span class="line">				&#125; else if (mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_CONTINUE ||</span><br><span class="line">                           sprddefInfo-&gt;slowmotion &gt; 1) &#123;</span><br><span class="line">                    setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);&#x2F;&#x2F;</span><br><span class="line">				&#125; else if (mRecordingMode &#x3D;&#x3D; true) &#123;</span><br><span class="line">                    setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_3);&#x2F;&#x2F;录像模式</span><br><span class="line">				&#125; else if (getMultiCameraMode() !&#x3D; 											MODE_SINGLE_FACEID_UNLOCK) &#123;</span><br><span class="line">                    setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_1);</span><br><span class="line">                &#125;</span><br><span class="line">                mIsPowerhintWait &#x3D; 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>接收jpeg图片时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void SprdCamera3OEMIf::receiveJpegPicture(struct camera_frame_type *frame) &#123;</span><br><span class="line">    if (getMultiCameraMode() &#x3D;&#x3D; MODE_BLUR ||</span><br><span class="line">        getMultiCameraMode() &#x3D;&#x3D; MODE_BOKEH ||</span><br><span class="line">        mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_3DNR_PHOTO) &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_4);</span><br><span class="line">    &#125; else if (mRecordingMode &#x3D;&#x3D; true) &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_3);</span><br><span class="line">    &#125; else if (mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_CONTINUE) &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void SprdCamera3OEMIf::HandleFocus(enum camera_cb_type cb, void *parm4) &#123;</span><br><span class="line">switch (cb) &#123;</span><br><span class="line">    case CAMERA_EXIT_CB_DONE:</span><br><span class="line">        HAL_LOGV(&quot;camera cb: autofocus succeeded.&quot;);</span><br><span class="line">        &#123;</span><br><span class="line">            if (mIsAutoFocus) &#123;</span><br><span class="line">                setCamPreformaceScene(mGetLastPowerHint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    case CAMERA_EXIT_CB_FAILED: &#123;</span><br><span class="line">        if (mIsAutoFocus) &#123;</span><br><span class="line">            setCamPreformaceScene(mGetLastPowerHint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">SprdCamera3OEMIf::SprdCamera3OEMIf(int cameraId, SprdCamera3Setting *setting)</span><br><span class="line">    : mSetCapRatioFlag(false), mVideoCopyFromPreviewFlag(false),</span><br><span class="line">      mSprdPipVivEnabled(0), mSprdHighIsoEnabled(0), mSprdFullscanEnabled(0),</span><br><span class="line">      mSprdRefocusEnabled(0), mSprd3dCalibrationEnabled(0), mSprdYuvCallBack(0),</span><br><span class="line">      mSprdMultiYuvCallBack(0), mSprdReprocessing(0), mNeededTimestamp(0),</span><br><span class="line">      mIsUnpopped(false), mIsBlur2Zsl(false),</span><br><span class="line">      mPreviewFormat(CAM_IMG_FMT_YUV420_NV21),</span><br><span class="line">      mVideoFormat(CAM_IMG_FMT_YUV420_NV21),</span><br><span class="line">      mCallbackFormat(CAM_IMG_FMT_YUV420_NV21),</span><br><span class="line">      mPictureFormat(CAM_IMG_FMT_YUV420_NV21),</span><br><span class="line">      mRawFormat(CAM_IMG_FMT_BAYER_MIPI_RAW), mPreviewStartFlag(0),</span><br><span class="line">      mIsDvPreview(0), mIsStoppingPreview(0), mRecordingMode(0),</span><br><span class="line">      mIsSetCaptureMode(false), mRecordingFirstFrameTime(0), mUser(0),</span><br><span class="line">      mPreviewWindow(NULL), mHalOem(NULL), mIsStoreMetaData(false),</span><br><span class="line">      mIsFreqChanged(false), mCameraId(cameraId), miSPreviewFirstFrame(1),</span><br><span class="line">      mCaptureMode(CAMERA_NORMAL_MODE), mCaptureRawMode(0), mFlashMask(false),</span><br><span class="line">      mReleaseFLag(false), mTimeCoeff(1), mIsPerformanceTestable(false),</span><br><span class="line">      mIsAndroidZSL(false), mSetting(setting), BurstCapCnt(0), mCapIntent(0),</span><br><span class="line">      mPrvTimerID(NULL), mFlashMode(-1), mIsAutoFocus(false),</span><br><span class="line">      mIspToolStart(false), mSubRawHeapNum(0), mGraphicBufNum(0), mEisGraphicBufNum(0),</span><br><span class="line">      mSubRawHeapSize(0), mPathRawHeapNum(0), mPathRawHeapSize(0),</span><br><span class="line">      mPreviewDcamAllocBufferCnt(0), mIsRecording(false),</span><br><span class="line">      mZSLModeMonitorMsgQueHandle(0), mZSLModeMonitorInited(0), mCNRMode(0),</span><br><span class="line">      mGyroInit(0), mGyroExit(0), mEisPreviewInit(false), mEisVideoInit(false),</span><br><span class="line">      mGyroNum(0), mSprdEisEnabled(false), mVideoSnapshotType(0),</span><br><span class="line">      mIommuEnabled(false), mFlashCaptureFlag(0),</span><br><span class="line">      mFlashCaptureSkipNum(FLASH_CAPTURE_SKIP_FRAME_NUM), mFixedFpsEnabled(0),</span><br><span class="line">      mSprdAppmodeId(-1), mTempStates(CAMERA_NORMAL_TEMP), mIsTempChanged(0),</span><br><span class="line">      mFlagOffLineZslStart(0), mZslSnapshotTime(0), mIsIspToolMode(0),</span><br><span class="line">      mIsUltraWideMode(false), mIsRawCapture(0), mIsCameraClearQBuf(0),</span><br><span class="line">      mLatestFocusDoneTime(0), mFaceDetectStartedFlag(0),</span><br><span class="line">      mIsJpegWithBigSizePreview(0)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    SprdCameraSystemPerformance::getSysPerformance(&amp;mSysPerformace);</span><br><span class="line">    if (mSysPerformace) &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>












</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/13/19-IT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/19-IT/" class="post-title-link" itemprop="url">IT</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 21:08:48" itemprop="dateCreated datePublished" datetime="2020-12-13T21:08:48+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-12 16:54:12" itemprop="dateModified" datetime="2020-12-12T16:54:12+08:00">2020-12-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="1.png" alt="img"></p>
<p><img src="2.png" alt="img"></p>
<p><img src="3.png" alt="img"></p>
<p><img src="4.png" alt="img"></p>
<p><img src="5.png" alt="img"></p>
<p><img src="6.png" alt="img"></p>
<p><img src="7.png" alt="img"></p>
<p><img src="8.png" alt="img"></p>
<p><img src="9.png" alt="img"></p>
<p><img src="10.png" alt="img"></p>
<p><img src="11.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/13/18-Email/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/18-Email/" class="post-title-link" itemprop="url">How To Write Email？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-13 21:08:48 / 修改时间：21:21:14" itemprop="dateCreated datePublished" datetime="2020-12-13T21:08:48+08:00">2020-12-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="写邮件的基本原则"><a href="#写邮件的基本原则" class="headerlink" title="写邮件的基本原则"></a>写邮件的基本原则</h1><ol>
<li>以终为始</li>
<li>传递正能量</li>
<li>让问题收敛，为邮件增加价值</li>
<li>让最合适的人来回复邮件</li>
<li>邮件永远都是公共场合</li>
</ol>
<h1 id="邮件撰写顺序"><a href="#邮件撰写顺序" class="headerlink" title="邮件撰写顺序"></a>邮件撰写顺序</h1><ol>
<li>附件</li>
<li>标题</li>
<li>正文</li>
<li>收件人</li>
</ol>
<h2 id="邮件Subject"><a href="#邮件Subject" class="headerlink" title="邮件Subject"></a>邮件Subject</h2><p>邮件的主题是编写邮件的中心思想，许多读者是以标题来决定是否继续详读信件的内容。主题所以需要：<br>明确主旨，简明扼要<br>邮件标题应力求简洁，让人一望即知，以便对方快速了解与记忆。 </p>
<p>常见问题：<br>Re:回复:XXXRe:转发:Re:答复:XXXRe:Foward:<br>标题和邮件内容已毫无关系<br>标题超长<br>没有标题</p>
<p>解决思路：<br>修正邮件标题，简短有效<br>裁剪邮件发送范围<br>另起邮件</p>
<h2 id="邮件正文"><a href="#邮件正文" class="headerlink" title="邮件正文"></a>邮件正文</h2><p>基本结构：<br>内容分段：背景 or 问题、结论、措施<br>同类分类：(1)… (2)… (3)…，标注序号<br>目的：减少NeedInfo Email，以满足不同读者关注点</p>
<p>抬头：按照公司文化写，可以用“Dear”开头</p>
<p>注意事项：<br>遵循金字塔原理，先说中心思想，再详细阐述细节<br>一行内容不要太长<br>建议用微软雅黑字体，字号适中（小四/五号）<br>强调的关键词用其他加粗，但不可用太多，建议不用<br>人名不能标红<br>多条并列内容要用编号/或符号排列<br>一个邮件一个主题思想<br>说的事情不要太多，事情多了就开会</p>
<h2 id="收件人-抄送-密送"><a href="#收件人-抄送-密送" class="headerlink" title="收件人/抄送/密送"></a>收件人/抄送/密送</h2><p>收件人需精准，不宜过多，责任更清晰（旁观者效应）</p>
<p>抄送：<br>什么情况，工作邮件应该抄送双方领导？<br>如何小心抄给客户怂么办？</p>
<p>密送：<br>什么情况下，工作邮件需要密送(BCC)？<br>密送背后的心理学。</p>
<h2 id="邮件转发"><a href="#邮件转发" class="headerlink" title="邮件转发"></a>邮件转发</h2><p>邮件转发时建议添加转发的缘由，尤其含有多位收件人的邮件时，注明转发的目的，若是指派任务，需要简要说明。让收件人更明确需要做什么。</p>
<p>如：<br>Add somebody + 说明Add的目的<br>FYI + 简要的说明</p>
<h2 id="邮件附件"><a href="#邮件附件" class="headerlink" title="邮件附件"></a>邮件附件</h2><p>附件少的时候最好不要打包（压缩成一个包）<br>附件尽可能小<br>邮件正文里做一下附件说明：附件中是 xx，请查收<br>收件人/抄送多人时，附件可单独发送问题处理人，并在含有多人的邮件中说明<br>因附件较多必须打包发送时，邮件正文应说明：<br>    压缩包中包括：<br>    1、xxxx 文档，是对 xxx 的说明<br>    2、xxxx 文档，是对 xxx 的说明<br>    3、xxxx 文档，是对 xxx 的说明</p>
<h2 id="表扬、感谢、批评邮件"><a href="#表扬、感谢、批评邮件" class="headerlink" title="表扬、感谢、批评邮件"></a>表扬、感谢、批评邮件</h2><p>什么情况应该感谢？<br>什么情况应该表扬？<br>如何进行批评？ —— 尽可能避免邮件</p>
<p>正面：聚焦具体行为和贡献，可抄送对方主管<br>负面：针对员工待改进行为及具体要求，缩小邮件范围</p>
<h2 id="群发邮件背后沟通问题"><a href="#群发邮件背后沟通问题" class="headerlink" title="群发邮件背后沟通问题"></a>群发邮件背后沟通问题</h2><p>大量垃圾邮件，导致大量无效沟通成本。<br>研发抱怨：邮件中没有告知Log，缺少CR号<br>测试抱怨：部分问题无人关注、无人反馈<br>对于尚未确定的客户需求/问题，群发某研发团队<br>导致FM/PM疲于奔命，客户还不满意</p>
<h2 id="邮件的类型"><a href="#邮件的类型" class="headerlink" title="邮件的类型"></a>邮件的类型</h2><h3 id="确认类型"><a href="#确认类型" class="headerlink" title="确认类型"></a>确认类型</h3><p>口头形成结论后，需要邮件确认和总结</p>
<ol>
<li><p>会议内容、结论，以及会后任务</p>
</li>
<li><p>电话沟通的结论</p>
</li>
<li><p>当面沟通达成的一致</p>
</li>
</ol>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>需要对需求描述具体、清晰、精确、可量化。避免因理解错误，实现与需求不一致，导致项目延期。</p>
<h3 id="反馈类"><a href="#反馈类" class="headerlink" title="反馈类"></a>反馈类</h3><p>迅速、有计划、可执行、跟踪和收尾</p>
<h3 id="广播类"><a href="#广播类" class="headerlink" title="广播类"></a>广播类</h3><p>纯粹知会性的广播邮件，一般不需要回复</p>
<h2 id="如何处理冲突邮件"><a href="#如何处理冲突邮件" class="headerlink" title="如何处理冲突邮件"></a>如何处理冲突邮件</h2><h3 id="客户批评你，抄送老板"><a href="#客户批评你，抄送老板" class="headerlink" title="客户批评你，抄送老板"></a>客户批评你，抄送老板</h3><p>第一步：<br>客户永远是对的<br>F2F或电话调查，确认问题原因<br>有初步方案后，第一时间和领导说明</p>
<p>第二步：<br>客户关注：你是否关注他？（抱怨、问题、想法）<br>上下游工作接口都是客户<br>经营你的人脉</p>
<p>改进思路：<br>每天电话/邮件沟通<br>避免客户犯错<br>逐步建立信任</p>
<h3 id="同事批评你，抄送主管"><a href="#同事批评你，抄送主管" class="headerlink" title="同事批评你，抄送主管"></a>同事批评你，抄送主管</h3><p>第一步：<br>无论善意恶意，别急于回复<br>对事不对人<br>有初步方案，与领导说明</p>
<p>第二步：<br>弄清来龙去脉<br>和对方当面沟通，了解背后原因<br>把双方认可结论，邮件告知相关人员<br>请主管回复</p>
<p>改进思路：<br>了解自身哪些需要改进<br>加强和对方的沟通频率</p>
<h3 id="吵架邮件"><a href="#吵架邮件" class="headerlink" title="吵架邮件"></a>吵架邮件</h3><h3 id="邮件中的情绪"><a href="#邮件中的情绪" class="headerlink" title="邮件中的情绪"></a>邮件中的情绪</h3><p>邮件格式-注意事项：<br>减少“！”的使用，尤其是多个“！”。<br>避免大量红色字体使用。<br>避免重复强调效果：加粗字体、红色字体、下划线、大号字体等。<br>多用“我们”，少用“你”和“我”。</p>
<h3 id="当你的邮件没有反馈"><a href="#当你的邮件没有反馈" class="headerlink" title="当你的邮件没有反馈"></a>当你的邮件没有反馈</h3><h2 id="邮件常用功能"><a href="#邮件常用功能" class="headerlink" title="邮件常用功能"></a>邮件常用功能</h2><h3 id="创建文件夹"><a href="#创建文件夹" class="headerlink" title="创建文件夹"></a>创建文件夹</h3><p>在Outlook系统中可以新建不同的文件夹，邮件可以进行分类存放，便于邮件的管理与查找。</p>
<p>步骤：<br>邮件文件夹列表→右键→ 新建文件夹→ 命名文件夹</p>
<h3 id="设置规则"><a href="#设置规则" class="headerlink" title="设置规则"></a>设置规则</h3><p>低关注度的邮件无法避免，可以通过设置规则管理好这部分邮件，避免淹没高价值邮件。</p>
<p>步骤：<br>邮件[开始] →规则→创建规则</p>
<h3 id="Out-Of-Office"><a href="#Out-Of-Office" class="headerlink" title="Out Of Office"></a>Out Of Office</h3><p>假如你休假了，可能长时间无法查看或及时回复邮件，可以在休假前设置好Out Of Office模式。设置好休假时间，代理人信息或方便联系到的方式。期间有人发邮件找你，可以第一时间告知发件人相关信息。</p>
<h3 id="邮件签名"><a href="#邮件签名" class="headerlink" title="邮件签名"></a>邮件签名</h3><p>签名中留下祝福语<br>要有联系方式<br>可以有紧急联系人及相关联系方式<br>可以有免职申明</p>
<h3 id="邮件与职业安全"><a href="#邮件与职业安全" class="headerlink" title="邮件与职业安全"></a>邮件与职业安全</h3><p>不要过于随便 —— 公司邮箱属于公共场合<br>内容公开原则 —— 过于担心，那不要写邮件<br>避免在邮件中宣泄情绪</p>
<h2 id="邮件的信息安全"><a href="#邮件的信息安全" class="headerlink" title="邮件的信息安全"></a>邮件的信息安全</h2><p>公司内部的如下邮件，都属于公司技术或管理机密：<br>公示批评/表扬邮件——避免对手散步不利我司信息<br>项目Kick-Off邮件——避免对手了解我司项目规划<br>项目测试报告——避免对手了解我司项目发展<br>研发技术讨论等</p>
<p>公司内部技术讨论邮件：<br>勿转发公司外部人员，避免机密技术信息泄露；<br>发给外部人员使用‘Replay’，而不是‘Replay With History’</p>
<p>回复客户邮件（CPM&amp;FAE）：<br>推荐养成新建习惯，可规避无意间“泄露公司机密”的风险。<br>邮件内容有误，第一时间通知收件人澄清，重新拟制。</p>
<h1 id="做人"><a href="#做人" class="headerlink" title="做人"></a>做人</h1><p>现在所做的每一件事都与未来人生息息相关。<br>真诚对待身边每一个人<br>认真做好日常每一件事</p>
<p>利他之心——生活与工作<br>保持个人利益与组织利益统一，利己利人<br>决策出发点：同时有益团队、公司、社会</p>
<p>胸怀不大度——构建良好团队人际关系<br>让每次合作变成积累，而不是消耗<br>让自己成为被组合的热门选手。</p>
<h1 id="做事"><a href="#做事" class="headerlink" title="做事"></a>做事</h1><p>永进不要忘记我们的目的<br>不是谁是谁非，而是解决问题<br>费斯汀格法则： 90/10定律<br>往者已矣，来者可追。<br>多关注问题发生后的回溯改进。<br>可以主导的最重要动作永远是下一个！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/13/13-%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/13-%E5%86%85%E6%A0%B8%E5%90%8C%E6%AD%A5/" class="post-title-link" itemprop="url">内核同步</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 21:08:48" itemprop="dateCreated datePublished" datetime="2020-12-13T21:08:48+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-18 19:23:41" itemprop="dateModified" datetime="2020-11-18T19:23:41+08:00">2020-11-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>#锁的争用<br>锁lock：使程序以串行方式对资源进行访问<br>lock contention：锁被占用时，其他线程等待获得该锁</p>
<p>锁的扩展性：<br>锁的粒度：粗锁保护大块数据，细锁保护小块数据<br>运行队列锁被争用：本质是在调度程序中把整个调度进程下放到单个处理器执行</p>
<h1 id="原子"><a href="#原子" class="headerlink" title="原子"></a>原子</h1><h2 id="原子整数操作"><a href="#原子整数操作" class="headerlink" title="原子整数操作"></a>原子整数操作</h2><h3 id="32位原子整数操作"><a href="#32位原子整数操作" class="headerlink" title="32位原子整数操作"></a>32位原子整数操作</h3><h3 id="64位原子整数操作"><a href="#64位原子整数操作" class="headerlink" title="64位原子整数操作"></a>64位原子整数操作</h3><h2 id="原子位操作"><a href="#原子位操作" class="headerlink" title="原子位操作"></a>原子位操作</h2><h1 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h1><p>自旋锁同一时刻只能被一个执行线程持有，其余想持有的必须等待，cpu一直忙等待，未睡眠。自旋就是等待自己释放锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">定义自旋锁</span><br><span class="line">初始化自旋锁</span><br><span class="line">获取自旋锁，保护临界区</span><br><span class="line">&#x2F;*临界区code &amp; data *&#x2F;</span><br><span class="line">解锁</span><br></pre></td></tr></table></figure>



<h1 id="读写自旋锁"><a href="#读写自旋锁" class="headerlink" title="读写自旋锁"></a>读写自旋锁</h1><p>允许读的并发，即可多个读进程，但只允许1个写进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">定义和初始化读写自旋锁</span><br><span class="line">读锁定</span><br><span class="line">读解锁</span><br><span class="line">写锁定</span><br><span class="line">写解锁</span><br></pre></td></tr></table></figure>



<h1 id="顺序锁"><a href="#顺序锁" class="headerlink" title="顺序锁"></a>顺序锁</h1><p>被顺序锁保护的共享资源，读和写不互斥。读期间发生了写，则需要重新读取数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">写顺序锁</span><br><span class="line">&#x2F;*写代码*&#x2F;</span><br><span class="line">释放写顺序锁</span><br></pre></td></tr></table></figure>



<h1 id="读-复制-更新"><a href="#读-复制-更新" class="headerlink" title="读-复制-更新"></a>读-复制-更新</h1><p>RCU：read-copy-update</p>
<h1 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h1><p>信号量，又名semaphore，是一种  用于同步和互斥的手段。<br>信号量的值可以是0，1，n。总之非负整数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">定义信号量</span><br><span class="line">初始化信号量</span><br><span class="line">获得信号量</span><br><span class="line">释放信号量</span><br></pre></td></tr></table></figure>
<p>信号量用于互斥和同步<br>互斥：<br>同步：</p>
<h1 id="PV原语"><a href="#PV原语" class="headerlink" title="PV原语"></a>PV原语</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">P(S)等价于S&#x3D;S-1</span><br><span class="line">if (S&gt;&#x3D;0)</span><br><span class="line">	进程继续；</span><br><span class="line">else</span><br><span class="line">	进程进入等待队列；</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">V(S)等价于S&#x3D;S+1</span><br><span class="line">if(S&gt;0)</span><br><span class="line">	该进程被唤醒，返回调用处继续执行</span><br><span class="line">else</span><br><span class="line">	从等待队列中唤醒一等待进程</span><br></pre></td></tr></table></figure>
<p>S=0<br>P(S)则S=-1，进程等待<br>V(S)则S=0，进程等待</p>
<h1 id="信号量与自旋锁的区别"><a href="#信号量与自旋锁的区别" class="headerlink" title="信号量与自旋锁的区别"></a>信号量与自旋锁的区别</h1><h1 id="计数信号量和二值信号量"><a href="#计数信号量和二值信号量" class="headerlink" title="计数信号量和二值信号量"></a>计数信号量和二值信号量</h1><h1 id="互斥体"><a href="#互斥体" class="headerlink" title="互斥体"></a>互斥体</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">定义互斥体</span><br><span class="line">初始化互斥体</span><br><span class="line">获取互斥体</span><br><span class="line">释放互斥体</span><br></pre></td></tr></table></figure>

<p>互斥体的实现依赖于自旋体，互斥体是进程级的，用于多个进程之间对资源的互斥。</p>
<h1 id="各种锁使用的场景pk"><a href="#各种锁使用的场景pk" class="headerlink" title="各种锁使用的场景pk"></a>各种锁使用的场景pk</h1><h1 id="完成量"><a href="#完成量" class="headerlink" title="完成量"></a>完成量</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/newnewman80/article/details/16112669">https://blog.csdn.net/newnewman80/article/details/16112669</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tureno/articles/6080923.html">https://www.cnblogs.com/tureno/articles/6080923.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linhaostudy/p/6670693.html">https://www.cnblogs.com/linhaostudy/p/6670693.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/p/7260696.html">https://www.cnblogs.com/edver/p/7260696.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38619183/article/details/83097475">https://blog.csdn.net/qq_38619183/article/details/83097475</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/13/12-SLAM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/12-SLAM/" class="post-title-link" itemprop="url">slam</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-13 21:08:48 / 修改时间：21:23:11" itemprop="dateCreated datePublished" datetime="2020-12-13T21:08:48+08:00">2020-12-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>近处的物体移动快，远处的物体运动缓慢，why？</p>
<p>单目：尺度不确定，平移才能计算深度<br>照片：场景在相机成像平面上留下的一个投影，以二维的形式反应三维的世界。</p>
<p>双目：左和右单目的基线已知，通过这个基线来估计每个像素的空间位置，计算量大。基线越大，能估计的范围就越大。</p>
<p>深度相机：RGB-D，使用红外结构光或TOF（time-of-flight）。主动向物体发射光并接收光来估计距离，容易受到日光干扰，无法测量透射材质。</p>
<p>SLAM框架：</p>
<ol>
<li>传感器数据：相机图像信息的获取和预处理</li>
<li>前端视觉里程计(visual odometry,VO)：估计相邻图像间相机的运动</li>
<li>后端非线性优化(optimization)：接受不同时刻，前端测量的相机位姿，以及回环检测的信息，对它们进行优化。</li>
<li>回环检测(loop closing)：判断是否曾经达到过先前的位置，如果检测到回环，则把它提供给后端处理。</li>
<li>建图(mapping)：根据估计的轨迹，建立与任务要求对应的地图。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/13/10-makefile%E5%A6%82%E4%BD%95%E4%B9%A6%E5%86%99%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/10-makefile%E5%A6%82%E4%BD%95%E4%B9%A6%E5%86%99%EF%BC%9F/" class="post-title-link" itemprop="url">makefile如何书写？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 21:08:48" itemprop="dateCreated datePublished" datetime="2020-12-13T21:08:48+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-17 15:07:44" itemprop="dateModified" datetime="2020-11-17T15:07:44+08:00">2020-11-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  1）如果这个工程没有编译过，那么我们的所有C文件都要编译并被链接。<br>  2）如果这个工程的某几个C文件被修改，那么我们只编译被修改的C文件，并链接目标程序。<br>  3）如果这个工程的头文件被改变了，那么我们需要编译引用了这几个头文件的C文件，并链接目标程序。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/13/9-hello.c%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/9-hello.c%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" class="post-title-link" itemprop="url">hello.c的生命周期</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 21:08:48" itemprop="dateCreated datePublished" datetime="2020-12-13T21:08:48+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-16 20:53:27" itemprop="dateModified" datetime="2020-11-16T20:53:27+08:00">2020-11-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="编译的整个过程：预编译、编译、汇编、链接"><a href="#编译的整个过程：预编译、编译、汇编、链接" class="headerlink" title="编译的整个过程：预编译、编译、汇编、链接"></a>编译的整个过程：预编译、编译、汇编、链接</h1><p>.c–&gt;.i–&gt;.s–&gt;.o–&gt;exe</p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116203340097.png" alt="image-20201116203340097"></p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116204031119.png" alt="image-20201116204031119"></p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116204145238.png" alt="image-20201116204145238"></p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116204514439.png" alt="image-20201116204514439"></p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116204524509.png" alt="image-20201116204524509"></p>
<p><strong>4.链接</strong></p>
<blockquote>
<p>链接器将生产的多个.o文件链接到一起生成一个可执行.exe文件；<br>但是在这个过程中，链接器做的一个重要的事情是将每个文件中call指令后面的地址补充上；方式是从当前文件的函数地址符表中开始找，如果没有，继续向别的文件的函数地址符表中找，找到后填补在call指令后面，如果找不到，则链接失败。**</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/12/13/7-c++_struct/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/7-c++_struct/" class="post-title-link" itemprop="url">c++入门--struct</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-13 21:08:48 / 修改时间：21:26:05" itemprop="dateCreated datePublished" datetime="2020-12-13T21:08:48+08:00">2020-12-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>date:2020.11.23</p>
<p>结构体：<br>下面声明了一个结构体Books，变量为book：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct Books</span><br><span class="line">&#123;</span><br><span class="line">	char title[50];</span><br><span class="line">	char author[50];</span><br><span class="line">	char subject[100];</span><br><span class="line">	int book_id;</span><br><span class="line">&#125;book;&#x2F;&#x2F;这里有分号</span><br></pre></td></tr></table></figure>
<p>如何访问结构体成员？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Books book1;&#x2F;&#x2F;定义结构体类型Books的变量book1</span><br><span class="line"></span><br><span class="line">book1.book_id &#x3D; 12;</span><br></pre></td></tr></table></figure>

<p>结构体作为函数参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void printBook(struct Books book)</span><br><span class="line">&#123;</span><br><span class="line">cout &lt;&lt; &quot;书标题&quot;&lt;&lt;book.title&lt;&lt;endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指向结构的指针：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;定义</span><br><span class="line">struct Books *struct_pointer;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;在指针变量struct_pointer中存储结构变量book1的地址</span><br><span class="line">struct_pointer &#x3D; &amp;book1;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;使用指针访问结构的成员</span><br><span class="line">struct_pointer-&gt;title;</span><br></pre></td></tr></table></figure>

<p>取别名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">typedef struct Books</span><br><span class="line">&#123;</span><br><span class="line">char title[50];</span><br><span class="line">char author[50];</span><br><span class="line">int book_id;</span><br><span class="line">&#125;Books;</span><br><span class="line"></span><br><span class="line">Books cfq_book,cqq_book;&#x2F;&#x2F;使用Books定义</span><br><span class="line"></span><br><span class="line">typedef long int *pointer_int32;</span><br><span class="line"></span><br><span class="line">pointer_int32 a,b,c;</span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Queenie Chen</p>
  <div class="site-description" itemprop="description">我叫小白，初来乍到，请多指教~</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Queenie Chen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
