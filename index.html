<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"queeniechen.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="我叫小白，初来乍到，请多指教~">
<meta property="og:type" content="website">
<meta property="og:title" content="Queenie Chen">
<meta property="og:url" content="https://queeniechen.github.io/index.html">
<meta property="og:site_name" content="Queenie Chen">
<meta property="og:description" content="我叫小白，初来乍到，请多指教~">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Queenie Chen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://queeniechen.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Queenie Chen</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Queenie Chen</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">三十功名尘与土，八千里路云和月</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/28/power-hint/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/28/power-hint/" class="post-title-link" itemprop="url">power hint机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-28 19:52:50" itemprop="dateCreated datePublished" datetime="2020-11-28T19:52:50+08:00">2020-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-30 08:12:16" itemprop="dateModified" datetime="2020-11-30T08:12:16+08:00">2020-11-30</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h1><p>这里camera场景指camera执行的不同阶段，比如open ,preview, take picture.  不同场景对camera性能和功耗要求不一样，比如open时想要快速，必须提频，此时功耗也就高了。如何设置调节策略使得各场景既能达到想要的反应速度，流畅水平，又使得能耗消耗在预期水平？由此引入power hint 机制。</p>
<p>总结一下：性能和功耗平衡需要策略</p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>不同的平台软、硬件配置不一样，性能不同，那么策略也有所不同。这里分为3个等级，分别是performance, normal, low power。</p>
<table>
<thead>
<tr>
<th>Power scene</th>
<th>CPU DVFS，</th>
<th>Thermal</th>
<th>DDR DFS</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Performance</strong></td>
<td>Generally，at least 4 CPU online &amp; Freq is veryhigh</td>
<td>Disable</td>
<td>Very  high/Normal</td>
</tr>
<tr>
<td><strong>Normal</strong></td>
<td>Default</td>
<td>Enable</td>
<td>Very high/Normal/Low</td>
</tr>
<tr>
<td><strong>Low power</strong></td>
<td>Some  projects have cpu hotplug &amp; Increase the proportion of running low Freq</td>
<td>Enable</td>
<td>Very  high//Normal/Low</td>
</tr>
</tbody></table>
<ol>
<li>performance：<br> 1）通常，至少4个cpu online，cpu freq很高<br> 2）拔核策略disable<br> 3）ddr dfs为high或者normal</li>
<li>normal：<br> 1）cpu频点默认<br> 2）拔核策略enable<br> 3）ddr dfs：high/normal/low</li>
<li>low power：<br> 1)增加跑低频的概率<br> 2)拔核策略enable<br> 3)ddr dfs：high/normal/low</li>
</ol>
<p>##1.1 hal3_2v1<br>对于open camera, close camera, stop preview(flush)，走的都是perforemance等级，ddr dfs走normal即可。</p>
<p>take picture走performance，ddr dfs走high。</p>
<p>recording走low power,ddr dfs也是normal。</p>
<p>普通预览走low power,ddr dfs也是low。</p>
<p>bokeh预览走normal，ddr dfs也是normal。</p>
<table>
<thead>
<tr>
<th>Power scene</th>
<th>CPU DVFS，</th>
<th>Thermal</th>
<th>DDR DFS</th>
<th>Camera  scene</th>
</tr>
</thead>
<tbody><tr>
<td>Performance</td>
<td>Generally，at least 4 CPU online  &amp;  Freq is veryhigh</td>
<td>Disable</td>
<td>normal</td>
<td>Open/close  Camera，stop preview (flush)</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Very High</td>
<td>Take  picture</td>
</tr>
<tr>
<td>Normal</td>
<td>Default</td>
<td>Enable</td>
<td>Normal</td>
<td>Preview  with Blu /Bokeh/Panorama</td>
</tr>
<tr>
<td>Low power</td>
<td>Some  projects have cpu hotplug /Increase the proportion of running low Freq</td>
<td>Enable</td>
<td>Normal</td>
<td>Recording</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Low</td>
<td>preview  under normal scene</td>
</tr>
</tbody></table>
<p><img src="1.png" alt="img"></p>
<p>##1.2 hal3_2v4</p>
<table>
<thead>
<tr>
<th>Power scene</th>
<th>CPU DVFS，</th>
<th>DDR DFS</th>
<th>Camera  scene</th>
</tr>
</thead>
<tbody><tr>
<td>Performance</td>
<td>Generally，at least 4 CPU online  &amp;  Freq is veryhigh</td>
<td>Normal（as default is Very high）</td>
<td>Open /close  Camera，</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Very high</td>
<td>Take  picture</td>
</tr>
<tr>
<td>Normal</td>
<td>Default</td>
<td>Normal （as default is Very high）</td>
<td>NULL</td>
</tr>
<tr>
<td>Low power</td>
<td>Just  Increase the proportion of running low Freq</td>
<td>Very high</td>
<td>Preview /  recording</td>
</tr>
</tbody></table>
<p><img src="2.png" alt="img"></p>
<h1 id="2-如何实现？"><a href="#2-如何实现？" class="headerlink" title="2. 如何实现？"></a>2. 如何实现？</h1><h2 id="2-1-怎么选择策略？"><a href="#2-1-怎么选择策略？" class="headerlink" title="2.1 怎么选择策略？"></a>2.1 怎么选择策略？</h2><p>各场景根据需要从如下的结构体中选择对应的策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef enum CAMERA_PERFORMACE_SCENE &#123;</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_1 &#x3D; 1,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_2,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_3,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_4,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_5,</span><br><span class="line">    CAM_PERFORMANCE_LEVEL_6,</span><br><span class="line">    CAM_PERFORMNCE_LEVEL_MAX</span><br><span class="line">&#125; sys_performance_camera_scene;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-1-setCamPreformaceScene"><a href="#2-1-1-setCamPreformaceScene" class="headerlink" title="2.1.1 setCamPreformaceScene"></a>2.1.1 setCamPreformaceScene</h3><p>问题来了，谁来选这个策略？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">void SprdCameraSystemPerformance::setCamPreformaceScene(</span><br><span class="line">    sys_performance_camera_scene camera_scene) &#123;</span><br><span class="line">    Mutex::Autolock l(&amp;mLock);</span><br><span class="line">#ifndef CONFIG_CAMERA_DFS_FIXED_MAXLEVEL</span><br><span class="line">    switch (camera_scene) &#123;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_6:</span><br><span class="line">        setPowerHint(CAM_POWER_PERFORMACE_ON);</span><br><span class="line">        changeDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_5:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_4:</span><br><span class="line">        setPowerHint(CAM_POWER_NORMAL);</span><br><span class="line">        changeDfsPolicy(CAM_NORMAL);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_3:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_2:</span><br><span class="line">        setPowerHint(CAM_POWER_LOWPOWER_ON);</span><br><span class="line">        changeDfsPolicy(CAM_NORMAL);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_1:</span><br><span class="line">        setPowerHint(CAM_POWER_LOWPOWER_ON);</span><br><span class="line">        changeDfsPolicy(CAM_LOW);</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGI(&quot;camera scene not support&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">#else</span><br><span class="line">#if (CONFIG_CAMERA_DFS_FIXED_MAXLEVEL &#x3D;&#x3D; 3)</span><br><span class="line">    changeDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">#elif(CONFIG_CAMERA_DFS_FIXED_MAXLEVEL &#x3D;&#x3D; 2)</span><br><span class="line">    changeDfsPolicy(CAM_NORMAL);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    switch (camera_scene) &#123;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_6:</span><br><span class="line">        setPowerHint(CAM_POWER_PERFORMACE_ON);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_5:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_4:</span><br><span class="line">        setPowerHint(CAM_POWER_NORMAL);</span><br><span class="line">        break;</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_3:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_2:</span><br><span class="line">    case CAM_PERFORMANCE_LEVEL_1:</span><br><span class="line">        setPowerHint(CAM_POWER_LOWPOWER_ON);</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGI(&quot;camera scene not support&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    mCurrentPowerHintScene &#x3D; camera_scene;</span><br><span class="line"></span><br><span class="line">    HAL_LOGD(&quot;x camera scene:%d&quot;, camera_scene);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又有2个问题，通过给函数setCamPreformaceScene传入具体参数camera_scene来选择策略，那么</p>
<ol>
<li>选择策略后，又是如何实现策略实施的呢？</li>
<li>谁给setCamPreformaceScene传的这个参数？</li>
</ol>
<h2 id="2-2-策略如何实施？"><a href="#2-2-策略如何实施？" class="headerlink" title="2.2 策略如何实施？"></a>2.2 策略如何实施？</h2><p>在setCamPreformaceScene这个函数体的实现中可以看到，根据不同配置有不同的策略方案。主要是：</p>
<ol>
<li>int SprdCameraSystemPerformance::changeDfsPolicy(dfs_policy_t dfs_policy)这个是来选择ddr dfs策略的</li>
<li>void SprdCameraSystemPerformance::setPowerHint(power_hint_state_type_t powerhint_id)这个是设置power hint的等级的</li>
</ol>
<p>ddr dfs等级结构体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef enum DFS_POLICY &#123;</span><br><span class="line">    CAM_EXIT,</span><br><span class="line">    CAM_LOW,</span><br><span class="line">    CAM_NORMAL,</span><br><span class="line">    CAM_VERYHIGH,</span><br><span class="line">&#125; dfs_policy_t;</span><br></pre></td></tr></table></figure>

<p>power scene结构体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef enum CURRENT_POWER_HINT &#123;</span><br><span class="line">    CAM_POWER_NORMAL,</span><br><span class="line">    CAM_POWER_PERFORMACE_ON,</span><br><span class="line">    CAM_POWER_PERFORMACE_ON</span><br><span class="line">&#125; power_hint_state_type_t;</span><br></pre></td></tr></table></figure>
<p>现在结构体是不是有点混乱？我们来理一理：<br>power_hint_state_type_t总共3个档次，对应之前说的NORMAL，PERFORMACE和PERFORMACE这3种策略。从表格中可以看出，不同的camera scene除了要选刚刚3种策略外，还要选中ddr dfs策略（这里dfs_policy_t有4档）。所以，由于cpu dvfs和ddr dfs都要选中，于是sys_performance_camera_scene就配出了多个来，这里是7个。实际代码实现顺序是先传camera_scene这个参数，再去适配cpu dvfs和ddr dfs。</p>
<h3 id="2-2-1-changeDfsPolicy"><a href="#2-2-1-changeDfsPolicy" class="headerlink" title="2.2.1 changeDfsPolicy"></a>2.2.1 changeDfsPolicy</h3><p>changeDfsPolicy这个函数是用来实现dfs_policy的选择的，当dfs_policy为CAM_EXIT时，根据当前dfs策略进行releaseDfsPolicy（mCameraDfsPolicyCur），设置完后将mCameraDfsPolicyCur = CAM_EXIT；当dfs_policyCAM_LOW时，setDfsPolicy（CAM_LOW），并且根据当前mCameraDfsPolicyCur来选择releaseDfsPolicy（）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">int SprdCameraSystemPerformance::changeDfsPolicy(dfs_policy_t dfs_policy) &#123;</span><br><span class="line"></span><br><span class="line">    switch (dfs_policy) &#123;</span><br><span class="line">    case CAM_EXIT:</span><br><span class="line">        if (CAM_LOW &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            releaseDfsPolicy(CAM_LOW);</span><br><span class="line">        &#125; else if (CAM_NORMAL &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            releaseDfsPolicy(CAM_NORMAL);</span><br><span class="line">        &#125; else if (CAM_VERYHIGH &#x3D;&#x3D; mCameraDfsPolicyCur)</span><br><span class="line">            releaseDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        mCameraDfsPolicyCur &#x3D; CAM_EXIT;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_LOW:</span><br><span class="line">        if (CAM_EXIT &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_LOW);</span><br><span class="line">        &#125; else if (CAM_NORMAL &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_LOW);</span><br><span class="line">            releaseDfsPolicy(CAM_NORMAL);</span><br><span class="line">        &#125; else if (CAM_VERYHIGH &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_LOW);</span><br><span class="line">            releaseDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        &#125;</span><br><span class="line">        mCameraDfsPolicyCur &#x3D; CAM_LOW;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_NORMAL:</span><br><span class="line">        if (CAM_EXIT &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_NORMAL);</span><br><span class="line">        &#125; else if (CAM_LOW &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_NORMAL);</span><br><span class="line">            releaseDfsPolicy(CAM_LOW);</span><br><span class="line">        &#125; else if (CAM_VERYHIGH &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_NORMAL);</span><br><span class="line">            releaseDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        &#125;</span><br><span class="line">        mCameraDfsPolicyCur &#x3D; CAM_NORMAL;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_VERYHIGH:</span><br><span class="line">        if (CAM_EXIT &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">        &#125; else if (CAM_LOW &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">            releaseDfsPolicy(CAM_LOW);</span><br><span class="line">        &#125; else if (CAM_NORMAL &#x3D;&#x3D; mCameraDfsPolicyCur) &#123;</span><br><span class="line">            setDfsPolicy(CAM_VERYHIGH);</span><br><span class="line">            releaseDfsPolicy(CAM_NORMAL);</span><br><span class="line">        &#125;</span><br><span class="line">        mCameraDfsPolicyCur &#x3D; CAM_VERYHIGH;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGW(&quot;unrecognize dfs policy&quot;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_LOGD(&quot;mCameraDfsPolicyCur: %d&quot;, mCameraDfsPolicyCur);</span><br><span class="line"></span><br><span class="line">    return NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-1-releaseDfsPolicy"><a href="#2-2-1-1-releaseDfsPolicy" class="headerlink" title="2.2.1.1 releaseDfsPolicy"></a>2.2.1.1 releaseDfsPolicy</h4><p>在releaseDfsPolicy（）这个函数里，根据不同的dfs_policy，设置dfs_scene值，并将其写入文件节点exit_scene</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">int SprdCameraSystemPerformance::releaseDfsPolicy(int dfs_policy) &#123;</span><br><span class="line"></span><br><span class="line">    const char *dfs_scene &#x3D; NULL;</span><br><span class="line">    const char *const scenario_dfs &#x3D;</span><br><span class="line">        &quot;&#x2F;sys&#x2F;class&#x2F;devfreq&#x2F;scene-frequency&#x2F;sprd_governor&#x2F;exit_scene&quot;;</span><br><span class="line">    FILE *fp &#x3D; fopen(scenario_dfs, &quot;wb&quot;);</span><br><span class="line">    if (NULL &#x3D;&#x3D; fp) &#123;</span><br><span class="line">        HAL_LOGW(&quot;failed to open %s X&quot;, scenario_dfs);</span><br><span class="line">        return BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch (dfs_policy) &#123;</span><br><span class="line">    case CAM_LOW:</span><br><span class="line">        dfs_scene &#x3D; CAM_LOW_STR;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_NORMAL:</span><br><span class="line">        dfs_scene &#x3D; CAM_NORMAL_STR;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_VERYHIGH:</span><br><span class="line">        dfs_scene &#x3D; CAM_VERYHIGH_STR;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGW(&quot;unrecognize dfs policy&quot;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_LOGD(&quot;release dfs_scene: %s&quot;, dfs_scene);</span><br><span class="line">    &#x2F;&#x2F; echo dfs_scene &gt; scenario_dfs</span><br><span class="line">    fprintf(fp, &quot;%s&quot;, dfs_scene);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    fp &#x3D; NULL;</span><br><span class="line">    return NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-2-setDfsPolicy"><a href="#2-2-1-2-setDfsPolicy" class="headerlink" title="2.2.1.2 setDfsPolicy"></a>2.2.1.2 setDfsPolicy</h4><p>在 setDfsPolicy（）这个函数里，根据不同的dfs_policy，设置dfs_scene值，并将其写入文件节点scenario_dfs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">int SprdCameraSystemPerformance::setDfsPolicy(int dfs_policy) &#123;</span><br><span class="line"></span><br><span class="line">    const char *dfs_scene &#x3D; NULL;</span><br><span class="line">    const char *const scenario_dfs &#x3D;</span><br><span class="line">        &quot;&#x2F;sys&#x2F;class&#x2F;devfreq&#x2F;scene-frequency&#x2F;sprd_governor&#x2F;scenario_dfs&quot;;</span><br><span class="line">    FILE *fp &#x3D; fopen(scenario_dfs, &quot;wb&quot;);</span><br><span class="line">    if (NULL &#x3D;&#x3D; fp) &#123;</span><br><span class="line">        HAL_LOGW(&quot;failed to open %s X&quot;, scenario_dfs);</span><br><span class="line">        return BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    switch (dfs_policy) &#123;</span><br><span class="line">    case CAM_LOW:</span><br><span class="line">        dfs_scene &#x3D; CAM_LOW_STR;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_NORMAL:</span><br><span class="line">        dfs_scene &#x3D; CAM_NORMAL_STR;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_VERYHIGH:</span><br><span class="line">        dfs_scene &#x3D; CAM_VERYHIGH_STR;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGW(&quot;unrecognize dfs policy&quot;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_LOGD(&quot;dfs_scene: %s&quot;, dfs_scene);</span><br><span class="line">    &#x2F;&#x2F; echo dfs_scene &gt; scenario_dfs</span><br><span class="line">    fprintf(fp, &quot;%s&quot;, dfs_scene);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    fp &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">    return NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-2-setPowerHint"><a href="#2-2-2-setPowerHint" class="headerlink" title="2.2.2 setPowerHint"></a>2.2.2 setPowerHint</h3><p>setPowerHint函数的实现，首先要考虑和判断当前powerhint策略。例如要设置成CAM_POWER_PERFORMACE_ON，而当前已经是CAM_POWER_PERFORMACE_ON了，就无需多做什么了。若当前策略为CAM_POWER_NORMAL，而目标等级CAM_POWER_PERFORMACE_ON，则</p>
<p>1）acquirePowerHint</p>
<p>2）重新设置mCurrentPowerHint</p>
<p>当前策略不是CAM_POWER_NORMAL时，而策略有变化时，需要先releasePowerHint当前策略，再获取策略，置状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">void SprdCameraSystemPerformance::setPowerHint(</span><br><span class="line">    power_hint_state_type_t powerhint_id) &#123;</span><br><span class="line"></span><br><span class="line">    if (!mPowermanageInited) &#123;</span><br><span class="line">        HAL_LOGE(&quot;need init.&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_LOGD(&quot;IN, mCurrentPowerHint&#x3D;%d&quot;, mCurrentPowerHint);</span><br><span class="line"></span><br><span class="line">#if (CONFIG_HAS_CAMERA_HINTS_VERSION &#x3D;&#x3D; ANDROID_VERSION_P)</span><br><span class="line">    switch (mCurrentPowerHint) &#123;</span><br><span class="line">    case CAM_POWER_NORMAL:</span><br><span class="line">        if (powerhint_id &#x3D;&#x3D; CAM_POWER_PERFORMACE_ON) &#123;</span><br><span class="line">            &#x2F;&#x2F; thermalEnabled(false);</span><br><span class="line">            acquirePowerHint(mScenePerformance);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_PERFORMACE_ON;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_LOWPOWER_ON) &#123;</span><br><span class="line">            acquirePowerHint(mSceneLowPower);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_LOWPOWER_ON;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_NORMAL) &#123;</span><br><span class="line">            HAL_LOGD(&quot;current power state is already CAM_POWER_NORMAL,&quot;</span><br><span class="line">                     &quot;state are both 0, just return&quot;);</span><br><span class="line">            goto exit;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_POWER_PERFORMACE_ON:</span><br><span class="line">        if (powerhint_id &#x3D;&#x3D; CAM_POWER_PERFORMACE_ON) &#123;</span><br><span class="line">            HAL_LOGD(&quot;current power state is already CAM_POWER_PERFORMACE_ON,&quot;</span><br><span class="line">                     &quot;state are both 1, just return&quot;);</span><br><span class="line">            goto exit;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_LOWPOWER_ON) &#123;</span><br><span class="line">            releasePowerHint(mScenePerformance);</span><br><span class="line">            acquirePowerHint(mSceneLowPower);</span><br><span class="line">            &#x2F;&#x2F; thermalEnabled(true);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_LOWPOWER_ON;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_NORMAL) &#123;</span><br><span class="line">            releasePowerHint(mScenePerformance);</span><br><span class="line">            &#x2F;&#x2F; thermalEnabled(true);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_NORMAL;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    case CAM_POWER_LOWPOWER_ON:</span><br><span class="line">        if (powerhint_id &#x3D;&#x3D; CAM_POWER_PERFORMACE_ON) &#123;</span><br><span class="line">            &#x2F;&#x2F; thermalEnabled(false);</span><br><span class="line">            releasePowerHint(mSceneLowPower);</span><br><span class="line">            acquirePowerHint(mScenePerformance);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_PERFORMACE_ON;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_LOWPOWER_ON) &#123;</span><br><span class="line">            HAL_LOGD(&quot;current power state is already CAM_POWER_LOWPOWER_ON,&quot;</span><br><span class="line">                     &quot;state are both 0, just return&quot;);</span><br><span class="line">            goto exit;</span><br><span class="line">        &#125; else if (powerhint_id &#x3D;&#x3D; CAM_POWER_NORMAL) &#123;</span><br><span class="line">            releasePowerHint(mSceneLowPower);</span><br><span class="line">            mCurrentPowerHint &#x3D; CAM_POWER_NORMAL;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        HAL_LOGE(&quot;should not be here&quot;);</span><br><span class="line">        goto exit;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">exit:</span><br><span class="line">    HAL_LOGD(&quot;out, mCurrentPowerHint&#x3D;%d&quot;, mCurrentPowerHint);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-2-1acquirePowerHint"><a href="#2-2-2-1acquirePowerHint" class="headerlink" title="2.2.2.1acquirePowerHint"></a>2.2.2.1acquirePowerHint</h4><p>acquirePowerHint主要由acquire()实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#if (CONFIG_HAS_CAMERA_HINTS_VERSION &#x3D;&#x3D; ANDROID_VERSION_P)</span><br><span class="line">void SprdCameraSystemPerformance::acquirePowerHint(</span><br><span class="line">    ::android::sp&lt;::android::PowerHintScene&gt; mScene) &#123;</span><br><span class="line"></span><br><span class="line">    if (mScene !&#x3D; NULL) &#123;</span><br><span class="line">        mScene-&gt;acquire();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-2-releasePowerHint"><a href="#2-2-2-2-releasePowerHint" class="headerlink" title="2.2.2.2 releasePowerHint"></a>2.2.2.2 releasePowerHint</h4><p>releasePowerHint主要由release()实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void SprdCameraSystemPerformance::releasePowerHint(</span><br><span class="line">    ::android::sp&lt;::android::PowerHintScene&gt; mScene) &#123;</span><br><span class="line"></span><br><span class="line">    if (mScene !&#x3D; NULL) &#123;</span><br><span class="line">        mScene-&gt;release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="谁来选择策略？"><a href="#谁来选择策略？" class="headerlink" title="谁来选择策略？"></a>谁来选择策略？</h2><p>我们来看看哪些地方调用了setCamPreformaceScene：</p>
<ol>
<li><p>关闭相机的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int SprdCamera3HWI::closeCamera() &#123;</span><br><span class="line">mOEMIf-&gt;setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>切换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int SprdCamera3HWI::flush() &#123;</span><br><span class="line">    if (mOEMIf) &#123;</span><br><span class="line">        mOEMIf-&gt;setFlushFlag(1);</span><br><span class="line">        mOEMIf-&gt;setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int SprdCamera3OEMIf::start(camera_channel_type_t channel_type,</span><br><span class="line">                            uint32_t frame_number) &#123;</span><br><span class="line">	setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自动对焦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">status_t SprdCamera3OEMIf::autoFocus() &#123;</span><br><span class="line">    if (mSysPerformace) &#123;</span><br><span class="line">        mGetLastPowerHint &#x3D; mSysPerformace-&gt;mCurrentPowerHintScene;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接收预览帧时，根据预览流，当时的模式选择不同的档次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void SprdCamera3OEMIf::receivePreviewFrame(struct camera_frame_type *frame) &#123;</span><br><span class="line">	if (pre_stream) &#123;</span><br><span class="line">		if (!isCapturing() &amp;&amp; mIsPowerhintWait &amp;&amp; !mIsAutoFocus) &#123;</span><br><span class="line">			if ((frame_num &gt; mStartFrameNum) &amp;&amp;(frame_num - 						mStartFrameNum &gt; CAM_POWERHINT_WAIT_COUNT)) &#123;</span><br><span class="line">				if (getMultiCameraMode() &#x3D;&#x3D; MODE_BLUR ||</span><br><span class="line">                    getMultiCameraMode() &#x3D;&#x3D; MODE_BOKEH ||</span><br><span class="line">                    mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_PANORAMA ||</span><br><span class="line">                    mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_3DNR_PHOTO ||</span><br><span class="line">                    mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_FILTER ||</span><br><span class="line">                    mSprdAppmodeId &#x3D;&#x3D; -1 ||</span><br><span class="line">                    (mRecordingMode &amp;&amp; !mVideoWidth &amp;&amp; !mVideoHeight))&#123;</span><br><span class="line">                    setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_4);</span><br><span class="line">				&#125; else if (mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_CONTINUE ||</span><br><span class="line">                           sprddefInfo-&gt;slowmotion &gt; 1) &#123;</span><br><span class="line">                    setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);&#x2F;&#x2F;</span><br><span class="line">				&#125; else if (mRecordingMode &#x3D;&#x3D; true) &#123;</span><br><span class="line">                    setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_3);&#x2F;&#x2F;录像模式</span><br><span class="line">				&#125; else if (getMultiCameraMode() !&#x3D; 											MODE_SINGLE_FACEID_UNLOCK) &#123;</span><br><span class="line">                    setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_1);</span><br><span class="line">                &#125;</span><br><span class="line">                mIsPowerhintWait &#x3D; 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>接收jpeg图片时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void SprdCamera3OEMIf::receiveJpegPicture(struct camera_frame_type *frame) &#123;</span><br><span class="line">    if (getMultiCameraMode() &#x3D;&#x3D; MODE_BLUR ||</span><br><span class="line">        getMultiCameraMode() &#x3D;&#x3D; MODE_BOKEH ||</span><br><span class="line">        mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_3DNR_PHOTO) &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_4);</span><br><span class="line">    &#125; else if (mRecordingMode &#x3D;&#x3D; true) &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_3);</span><br><span class="line">    &#125; else if (mSprdAppmodeId &#x3D;&#x3D; CAMERA_MODE_CONTINUE) &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void SprdCamera3OEMIf::HandleFocus(enum camera_cb_type cb, void *parm4) &#123;</span><br><span class="line">switch (cb) &#123;</span><br><span class="line">    case CAMERA_EXIT_CB_DONE:</span><br><span class="line">        HAL_LOGV(&quot;camera cb: autofocus succeeded.&quot;);</span><br><span class="line">        &#123;</span><br><span class="line">            if (mIsAutoFocus) &#123;</span><br><span class="line">                setCamPreformaceScene(mGetLastPowerHint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    case CAMERA_EXIT_CB_FAILED: &#123;</span><br><span class="line">        if (mIsAutoFocus) &#123;</span><br><span class="line">            setCamPreformaceScene(mGetLastPowerHint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">SprdCamera3OEMIf::SprdCamera3OEMIf(int cameraId, SprdCamera3Setting *setting)</span><br><span class="line">    : mSetCapRatioFlag(false), mVideoCopyFromPreviewFlag(false),</span><br><span class="line">      mSprdPipVivEnabled(0), mSprdHighIsoEnabled(0), mSprdFullscanEnabled(0),</span><br><span class="line">      mSprdRefocusEnabled(0), mSprd3dCalibrationEnabled(0), mSprdYuvCallBack(0),</span><br><span class="line">      mSprdMultiYuvCallBack(0), mSprdReprocessing(0), mNeededTimestamp(0),</span><br><span class="line">      mIsUnpopped(false), mIsBlur2Zsl(false),</span><br><span class="line">      mPreviewFormat(CAM_IMG_FMT_YUV420_NV21),</span><br><span class="line">      mVideoFormat(CAM_IMG_FMT_YUV420_NV21),</span><br><span class="line">      mCallbackFormat(CAM_IMG_FMT_YUV420_NV21),</span><br><span class="line">      mPictureFormat(CAM_IMG_FMT_YUV420_NV21),</span><br><span class="line">      mRawFormat(CAM_IMG_FMT_BAYER_MIPI_RAW), mPreviewStartFlag(0),</span><br><span class="line">      mIsDvPreview(0), mIsStoppingPreview(0), mRecordingMode(0),</span><br><span class="line">      mIsSetCaptureMode(false), mRecordingFirstFrameTime(0), mUser(0),</span><br><span class="line">      mPreviewWindow(NULL), mHalOem(NULL), mIsStoreMetaData(false),</span><br><span class="line">      mIsFreqChanged(false), mCameraId(cameraId), miSPreviewFirstFrame(1),</span><br><span class="line">      mCaptureMode(CAMERA_NORMAL_MODE), mCaptureRawMode(0), mFlashMask(false),</span><br><span class="line">      mReleaseFLag(false), mTimeCoeff(1), mIsPerformanceTestable(false),</span><br><span class="line">      mIsAndroidZSL(false), mSetting(setting), BurstCapCnt(0), mCapIntent(0),</span><br><span class="line">      mPrvTimerID(NULL), mFlashMode(-1), mIsAutoFocus(false),</span><br><span class="line">      mIspToolStart(false), mSubRawHeapNum(0), mGraphicBufNum(0), mEisGraphicBufNum(0),</span><br><span class="line">      mSubRawHeapSize(0), mPathRawHeapNum(0), mPathRawHeapSize(0),</span><br><span class="line">      mPreviewDcamAllocBufferCnt(0), mIsRecording(false),</span><br><span class="line">      mZSLModeMonitorMsgQueHandle(0), mZSLModeMonitorInited(0), mCNRMode(0),</span><br><span class="line">      mGyroInit(0), mGyroExit(0), mEisPreviewInit(false), mEisVideoInit(false),</span><br><span class="line">      mGyroNum(0), mSprdEisEnabled(false), mVideoSnapshotType(0),</span><br><span class="line">      mIommuEnabled(false), mFlashCaptureFlag(0),</span><br><span class="line">      mFlashCaptureSkipNum(FLASH_CAPTURE_SKIP_FRAME_NUM), mFixedFpsEnabled(0),</span><br><span class="line">      mSprdAppmodeId(-1), mTempStates(CAMERA_NORMAL_TEMP), mIsTempChanged(0),</span><br><span class="line">      mFlagOffLineZslStart(0), mZslSnapshotTime(0), mIsIspToolMode(0),</span><br><span class="line">      mIsUltraWideMode(false), mIsRawCapture(0), mIsCameraClearQBuf(0),</span><br><span class="line">      mLatestFocusDoneTime(0), mFaceDetectStartedFlag(0),</span><br><span class="line">      mIsJpegWithBigSizePreview(0)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    SprdCameraSystemPerformance::getSysPerformance(&amp;mSysPerformace);</span><br><span class="line">    if (mSysPerformace) &#123;</span><br><span class="line">        setCamPreformaceScene(CAM_PERFORMANCE_LEVEL_6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>












</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/22/gcov/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/gcov/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-22 23:14:52 / 修改时间：23:32:06" itemprop="dateCreated datePublished" datetime="2020-11-22T23:14:52+08:00">2020-11-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h2 id="title-gcov代码覆盖率测试"><a href="#title-gcov代码覆盖率测试" class="headerlink" title="title:gcov代码覆盖率测试"></a>title:gcov代码覆盖率测试</h2><h1 id="GCOV是什么？"><a href="#GCOV是什么？" class="headerlink" title="GCOV是什么？"></a>GCOV是什么？</h1><p>Gcov是<strong>测试代码覆盖率的工具</strong>，配合gcc一起实现对c/c++文件的语句覆盖和分支覆盖。</p>
<p>Gcov能做什么？<br>每行代码执行的频次<br>实际执行了哪些代码<br>每段代码执行花耗的时间</p>
<p><img src="1.png" alt="img"></p>
<h1 id="gcov的执行过程概况"><a href="#gcov的执行过程概况" class="headerlink" title="gcov的执行过程概况"></a>gcov的执行过程概况</h1><p><img src="2.png" alt="img"><br>所谓桩点，其实就是一个变量，内存中的一个格子，对应的代码执行一次，则其值增加一次；</p>
<p>仍有2个问题：</p>
<ol>
<li>为什么是汇编文件插桩？</li>
<li>如何插桩？</li>
</ol>
<h1 id="Gcov-amp-lcov-生成报告的4个过程"><a href="#Gcov-amp-lcov-生成报告的4个过程" class="headerlink" title="Gcov &amp; lcov 生成报告的4个过程"></a>Gcov &amp; lcov 生成报告的4个过程</h1><p><img src="3.png" alt="img"><br>说明：</p>
<ol>
<li>对.c和.h文件进行编译，会生成汇编.s，可执行文件helloworld_gcov以及.gcno文件。其中编译规则中加入编译器参数-ftest-coverage是为了生成.gcno文件。加入-fprofile-arcs 是为了生成.gcda文件。</li>
<li>执行刚刚生成的可执行文件，可得到.gcda文件。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;helloworld_gcov</span><br></pre></td></tr></table></figure></li>
<li>通过运行命令，生成.c.gcov文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcov helloworld_gcov.c</span><br></pre></td></tr></table></figure></li>
<li>再根据.gcno和.gcda文件生成图形化报告</li>
</ol>
<p>问题：<br>.c.gcov，.gcda，.gcno文件格式？</p>
<h1 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/22/makefile%E5%A6%82%E4%BD%95%E4%B9%A6%E5%86%99%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/makefile%E5%A6%82%E4%BD%95%E4%B9%A6%E5%86%99%EF%BC%9F/" class="post-title-link" itemprop="url">makefile如何书写？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-22 19:33:25" itemprop="dateCreated datePublished" datetime="2020-11-22T19:33:25+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-17 15:07:44" itemprop="dateModified" datetime="2020-11-17T15:07:44+08:00">2020-11-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>  1）如果这个工程没有编译过，那么我们的所有C文件都要编译并被链接。<br>  2）如果这个工程的某几个C文件被修改，那么我们只编译被修改的C文件，并链接目标程序。<br>  3）如果这个工程的头文件被改变了，那么我们需要编译引用了这几个头文件的C文件，并链接目标程序。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/22/hello.c%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/hello.c%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" class="post-title-link" itemprop="url">hello.c的生命周期</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-22 19:33:25" itemprop="dateCreated datePublished" datetime="2020-11-22T19:33:25+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-16 20:53:27" itemprop="dateModified" datetime="2020-11-16T20:53:27+08:00">2020-11-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="编译的整个过程：预编译、编译、汇编、链接"><a href="#编译的整个过程：预编译、编译、汇编、链接" class="headerlink" title="编译的整个过程：预编译、编译、汇编、链接"></a>编译的整个过程：预编译、编译、汇编、链接</h1><p>.c–&gt;.i–&gt;.s–&gt;.o–&gt;exe</p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116203340097.png" alt="image-20201116203340097"></p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116204031119.png" alt="image-20201116204031119"></p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116204145238.png" alt="image-20201116204145238"></p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116204514439.png" alt="image-20201116204514439"></p>
<p><img src="C:\Users\fuqu.chen\AppData\Roaming\Typora\typora-user-images\image-20201116204524509.png" alt="image-20201116204524509"></p>
<p><strong>4.链接</strong></p>
<blockquote>
<p>链接器将生产的多个.o文件链接到一起生成一个可执行.exe文件；<br>但是在这个过程中，链接器做的一个重要的事情是将每个文件中call指令后面的地址补充上；方式是从当前文件的函数地址符表中开始找，如果没有，继续向别的文件的函数地址符表中找，找到后填补在call指令后面，如果找不到，则链接失败。**</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/22/android-%E5%AE%9A%E5%88%B6%E4%BA%A7%E5%93%81%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E7%83%A7%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/android-%E5%AE%9A%E5%88%B6%E4%BA%A7%E5%93%81%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E7%83%A7%E5%BD%95/" class="post-title-link" itemprop="url">android 定制产品的编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-22 19:33:25" itemprop="dateCreated datePublished" datetime="2020-11-22T19:33:25+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-20 19:51:30" itemprop="dateModified" datetime="2020-11-20T19:51:30+08:00">2020-11-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="定制新产品"><a href="#定制新产品" class="headerlink" title="定制新产品"></a>定制新产品</h1><h2 id="在device目录下添加文件夹"><a href="#在device目录下添加文件夹" class="headerlink" title="在device目录下添加文件夹"></a>在device目录下添加文件夹</h2><h3 id="device-目录的组织架构"><a href="#device-目录的组织架构" class="headerlink" title="device 目录的组织架构"></a>device 目录的组织架构</h3><p>device–&gt;company–&gt;product–&gt;(vendorsetup.sh, AndroidProducts.mk, BoardConfig.mk, device.mk,…)</p>
<h3 id="定制新设备所需的配置文件分类"><a href="#定制新设备所需的配置文件分类" class="headerlink" title="定制新设备所需的配置文件分类"></a>定制新设备所需的配置文件分类</h3><p>底层往上：芯片架构–&gt;核心板–&gt;设备–&gt; 产品<br>芯片架构(architecture)：产品所需的硬件架构，eg: x86, arm<br>核心板层(board)：<br>设备层(device)：外围设备的配置<br>产品层(product)：软件模块和配置</p>
<h2 id="vendorsetup-sh"><a href="#vendorsetup-sh" class="headerlink" title="vendorsetup.sh"></a>vendorsetup.sh</h2><p>该脚本告知系统添加了目录，脚本内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add_lunch_combo full_toro_userdebug</span><br><span class="line">函数add_lunch_combo作用：将参数full_toro_userdebug描述的产品添加到系统相关变量中，后面Lunch的选单就是基于这些变量产生的</span><br></pre></td></tr></table></figure>
<p>何时调用 vendorsetup.sh ？<br>vendorsetup.sh被envsetup.sh调用，在envsetup.sh脚本里有个for循环，扫描工程里所有可用的vendorsetup.sh，一般默认扫描vendor和device目录。<br>这里就有点类似超市工作人员（编译系统）扫描仓库（vendor和device目录），清点有哪些商品(vendorsetup.sh负责记录)，并通过一定方式上架(add_lunch_combo)，消费者再选购(lunch)。    </p>
<h2 id="添加AndroidProducts-mk"><a href="#添加AndroidProducts-mk" class="headerlink" title="添加AndroidProducts.mk"></a>添加AndroidProducts.mk</h2><p>通过AndroidProducts.mk指向其他.mk文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_MAKEFILES :&#x3D; \</span><br><span class="line">	$(LOCAL_PATH)&#x2F;aosp_toro.mk \</span><br><span class="line">	$(LOCAL_PATH)&#x2F;full_toro.mk</span><br></pre></td></tr></table></figure>
<p>其中aosp_toro.mk和full_toro.mk是某产品专用makefile文件。</p>
<h2 id="实现上述某产品专用的makefile文件"><a href="#实现上述某产品专用的makefile文件" class="headerlink" title="实现上述某产品专用的makefile文件"></a>实现上述某产品专用的makefile文件</h2><p>利用<strong>系统已有</strong>的**<em>全局**</em>变量和函数实现需要的功能</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>变量</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>PRODUCT_NAME</td>
<td>产品名称</td>
</tr>
<tr>
<td>2</td>
<td>PRODUCT_DEVICE</td>
<td>设备名称</td>
</tr>
<tr>
<td>3</td>
<td>PRODUCT_BRAND</td>
<td>产品所属品牌</td>
</tr>
<tr>
<td>4</td>
<td>PRODUCT_MANUFACTURER</td>
<td>产品生产商</td>
</tr>
<tr>
<td>5</td>
<td>PRODUCT_MODEL</td>
<td>产品型号</td>
</tr>
<tr>
<td>6</td>
<td>PRODUCT_PACKAGES</td>
<td>系统需预装的一系列程序</td>
</tr>
<tr>
<td>7</td>
<td>PRODUCT_LOCALES</td>
<td>所支持的国家语言</td>
</tr>
<tr>
<td>8</td>
<td>PRODUCT_POLICY</td>
<td>本产品遵循的策略。例：android.policy_phone</td>
</tr>
<tr>
<td>9</td>
<td>PRODUCT_TAGS</td>
<td>产品 标签描述，以空格分隔</td>
</tr>
<tr>
<td></td>
<td>PRODUCT_PROPERTY_OVERRIDES</td>
<td>用于重载系统属性，存储在/system/build/.prop文件中。格式：key=value，例：ro.product.firmware=v0.4rc1</td>
</tr>
</tbody></table>
<h2 id="添加BoardConfig-mk文件"><a href="#添加BoardConfig-mk文件" class="headerlink" title="添加BoardConfig.mk文件"></a>添加BoardConfig.mk文件</h2><ol>
<li>目标架构</li>
<li>硬件设备属性</li>
<li>编译器的条件标志</li>
<li>分区布局</li>
<li>Boot地址</li>
<li>ramdisk大小</li>
</ol>
<h2 id="添加Android-mk"><a href="#添加Android-mk" class="headerlink" title="添加Android.mk"></a>添加Android.mk</h2><p>产品由很多模块组成，Android.mk是生产某个模块的“生产工序”。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/22/android-%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/android-%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">原生态android 编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-22 19:33:25" itemprop="dateCreated datePublished" datetime="2020-11-22T19:33:25+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-19 11:12:11" itemprop="dateModified" datetime="2020-11-19T11:12:11+08:00">2020-11-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="关于交叉编译"><a href="#关于交叉编译" class="headerlink" title="关于交叉编译"></a>关于交叉编译</h1><h2 id="什么是交叉编译？"><a href="#什么是交叉编译？" class="headerlink" title="什么是交叉编译？"></a>什么是交叉编译？</h2><h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><p>（1）目标平台由于种种原因（无法安装编译器，资源有限导致编译不正常）<br>（2）需要另外一个平台辅助生成可执行文件</p>
<p>平台是指？<br>平台=硬件+ 操作系统环境</p>
<h3 id="引出相关概念："><a href="#引出相关概念：" class="headerlink" title="引出相关概念："></a>引出相关概念：</h3><p>宿主机（host）：开发和编译代码所在平台<br>目标机（target）：宿主机编译生成的系统包就是提供给目标机使用的<br>交叉编译器（cross compiler）：本身在宿主机上运行，用于产生目标机可执行文件的编译器</p>
<h3 id="常用交叉编译器及应用环境"><a href="#常用交叉编译器及应用环境" class="headerlink" title="常用交叉编译器及应用环境"></a>常用交叉编译器及应用环境</h3><ol>
<li>在Windows PC上，利用ADS ARM开发环境，使用armcc编译器，可编译出针对ARMCPU的可执行代码。</li>
<li>在Linux PC上，利用arm-linux-gcc编译器，可编译出针对Linux ARM平台的可执行代码。</li>
<li>在Windows PC上，利用cygwin环境，运行arm-elf-gcc编译器，可编译出针对ARM CPU的可执行代码。</li>
<li>在Windows系统上，利用Keil Uvison工具，开发出运行在89C51单片机上的程序。</li>
<li>在Windows系统上，利用CodeWarrior IDE工具，开发出运行在Freescale XS128单片机上的程序。<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3>编译的环境和运行的环境是不一样，是属于交叉的，此所谓cross；</li>
</ol>
<h1 id="建立android编译环境"><a href="#建立android编译环境" class="headerlink" title="建立android编译环境"></a>建立android编译环境</h1><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>宿主机：linux x86 pc<br>宿主机操作系统：ubuntu 14.04 LTS<br>交叉编译器：arm-linux-gcc<br>通用编译工具：<br>（1）python2.x<br>（2）GNU make 3.81-3.82<br>（3）JDK<br>（4）git 1.7以上版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装版本下载地址及相应安装命令如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h1><h3 id="step1-执行envsetup-sh"><a href="#step1-执行envsetup-sh" class="headerlink" title="step1: 执行envsetup.sh"></a>step1: 执行envsetup.sh</h3><p>envsetup.sh记录编译过程中所需的各种函数实现，如lunch ,mm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source .&#x2F;build&#x2F;envsetup.sh</span><br><span class="line">等价于</span><br><span class="line">. .&#x2F;build&#x2F;envsetup.sh</span><br></pre></td></tr></table></figure>
<h3 id="step2-选择编译目标"><a href="#step2-选择编译目标" class="headerlink" title="step2: 选择编译目标"></a>step2: 选择编译目标</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lunch</span><br></pre></td></tr></table></figure>
<p>输入lunch后会弹出工程配置好的所有产品类型，我们再进行产品类型的选择</p>
<h3 id="step3：执行编译命令"><a href="#step3：执行编译命令" class="headerlink" title="step3：执行编译命令"></a>step3：执行编译命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>
<p>也可以充分利用cpu资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j4</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="如何编译出SDK？"><a href="#如何编译出SDK？" class="headerlink" title="如何编译出SDK？"></a>如何编译出SDK？</h3><h4 id="mac-os和linux下"><a href="#mac-os和linux下" class="headerlink" title="mac os和linux下"></a>mac os和linux下</h4><ol>
<li>下载源码</li>
<li>source ./build/envsetup.sh</li>
<li>lunch sdk-eng</li>
<li>make sdk</li>
</ol>
<h4 id="windows下"><a href="#windows下" class="headerlink" title="windows下"></a>windows下</h4><ol>
<li>在linux下生成sdk</li>
<li>安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mingw32 tofrodos</span><br></pre></td></tr></table></figure></li>
<li> 再次编译<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source .&#x2F;build&#x2F;envsetup.sh</span><br><span class="line">lunch sdk-eng</span><br><span class="line">make win_sdk</span><br></pre></td></tr></table></figure>













</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/22/linux-synchronize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/linux-synchronize/" class="post-title-link" itemprop="url">内核同步</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-22 19:33:25 / 修改时间：22:55:19" itemprop="dateCreated datePublished" datetime="2020-11-22T19:33:25+08:00">2020-11-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="临界区，临界资源，并发，竞争条件，同步"><a href="#临界区，临界资源，并发，竞争条件，同步" class="headerlink" title="临界区，临界资源，并发，竞争条件，同步"></a>临界区，临界资源，并发，竞争条件，同步</h1><p><strong>临界区</strong>就是访问和操作共享数据的代码段。<br>属于<strong>临界资源</strong>的硬件有打印机、磁带机等,软件有消息缓冲队列、变量、数组、缓冲区等。</p>
<p>示意图如下：</p>
<p><img src="1.png" alt="img"></p>
<p>如上图，代码段code1,code2,code3分别都访问和操作同一块数据区域，因此这些代码段就是临界区，而这块数据区域就是临界资源。实际上，code离不开data，笔者认为临界区也包括了指令操作的数据，正如上图红色，黄色，绿色所圈。</p>
<p>试想，倘若操作的先后顺便不一致，共享数据最终的呈现状态会不会不一样呢？<br><strong>并发</strong>指多个执行单元<strong>同时</strong>访问同一个资源。<br><strong>竞争条件</strong>指多个线程或者进程在读写一个共享数据时结果依赖于它们<strong>执行的相对时间</strong>的情形。</p>
<p><strong>同步</strong>就是避免并发和防止竞争条件。</p>
<p><img src="2.png" alt="img"></p>
<p>假设线程1执行指令i++，线程2执行指令++i。每一行代表一个时间片。上面表示线程1执行完后才执行线程2.  下面表示，线程1和线程2同时获得变量i，此时i的值为8，下一个时间片，线程1进行i++操作，而线程2在此时未处理（sleep），接下来的一个时间片，线程1sleep，而线程2进行++i操作。接下来的又一个时间片，线程1得到i的值为9，线程2得到的i的值也为9. </p>
<p>#死锁<br><strong>死锁</strong>就是线程等待的资源不释放，线程无法继续。<br><strong>自死锁</strong>：线程试图获得自己已持有的锁。<br><strong>ABBA死锁</strong>：如下图，每行表示一个时间片，线程1和线程2同时分别获得锁A和锁B，在下一个时间片，线程1试图获取锁B（已被线程2持有，需要等待线程2释放锁B），线程2试图获取锁A（已被线程1持有，需要等待线程1释放锁A）。然而，线程2想要释放锁B，就必须先完成获得锁A这件事，它在等待线程1释放锁A。线程1想要释放锁A，就必须先完成获得锁B这件事，它在等待线程2释放锁B。于是，线程1和线程2由于相互想要获得对方的锁，进入死锁状态，这就是ABBA死锁。<br><img src="3.png" alt="img"></p>
<p><strong>如何规避死锁</strong></p>
<ol>
<li>按加锁相反的顺序解锁：加锁（a-&gt;b-&gt;c），解锁（c-&gt;b-&gt;a）</li>
<li>防止饥饿：设置超时时间，防止永远等待</li>
<li>不要重复请求 同一个锁</li>
<li>加锁方案要设计得简单</li>
</ol>
<p>#锁的争用<br>锁lock：使程序以串行方式对资源进行访问<br>lock contention：锁被占用时，其他线程等待获得该锁</p>
<p>锁的扩展性：<br>锁的粒度：粗锁保护大块数据，细锁保护小块数据<br>运行队列锁被争用：本质是在调度程序中把整个调度进程下放到单个处理器执行</p>
<h1 id="原子"><a href="#原子" class="headerlink" title="原子"></a>原子</h1><p><strong>原子操作</strong>：指令执行过程不被打断<br>原子操作只能用于临界区只有一个变量的情况。</p>
<p>为什么可以不被打断？</p>
<h2 id="原子整数操作"><a href="#原子整数操作" class="headerlink" title="原子整数操作"></a>原子整数操作</h2><h3 id="32位原子整数操作"><a href="#32位原子整数操作" class="headerlink" title="32位原子整数操作"></a>32位原子整数操作</h3><p>原子整数操作：只对atomic类型数据进行处理<br><img src="4.png" alt="img"></p>
<p>函数及相应的描述：<br><img src="5.png" alt="img"></p>
<h3 id="64位原子整数操作"><a href="#64位原子整数操作" class="headerlink" title="64位原子整数操作"></a>64位原子整数操作</h3><h2 id="原子位操作"><a href="#原子位操作" class="headerlink" title="原子位操作"></a>原子位操作</h2><p><img src="5-1.png" alt="img"></p>
<p><img src="5-2.png" alt="img"></p>
<p><img src="5-3.png" alt="img"></p>
<h1 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h1><p>自旋锁同一时刻只能被一个执行线程持有，其余想持有的必须等待，cpu一直忙等待，未睡眠,所以会造成CPU处理时间的浪费。自旋就是等待自己释放锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">定义自旋锁</span><br><span class="line">初始化自旋锁</span><br><span class="line">获取自旋锁，保护临界区</span><br><span class="line">&#x2F;*临界区code &amp; data *&#x2F;</span><br><span class="line">解锁</span><br></pre></td></tr></table></figure>
<p>自旋锁使用时有2点需要注意：<br>1：自旋锁是<strong>不可递归</strong>的，递归的请求同一个自旋锁会自己锁死自己。</p>
<p>2：线程获取自旋锁之前，要禁止当前处理器上的中断。（防止获取锁的线程和中断形成竞争条件）<br>比如：当前线程获取自旋锁后，在临界区中被中断处理程序打断，中断处理程序正好也要获取这个锁，于是中断处理程序会等待当前线程释放锁，而当前线程也在等待中断执行完后再执行临界区和释放锁的代码。</p>
<p>笔者认为这里就是ABBA锁，只不过这里线程2恰巧就是中断而已。</p>
<p><img src="6.png" alt="img"></p>
<h1 id="读写自旋锁"><a href="#读写自旋锁" class="headerlink" title="读写自旋锁"></a>读写自旋锁</h1><p>允许读的并发，即可多个读进程，但只允许1个写进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">定义和初始化读写自旋锁</span><br><span class="line">读锁定</span><br><span class="line">读解锁</span><br><span class="line">写锁定</span><br><span class="line">写解锁</span><br></pre></td></tr></table></figure>



<h1 id="顺序锁"><a href="#顺序锁" class="headerlink" title="顺序锁"></a>顺序锁</h1><p>被顺序锁保护的共享资源，读和写不互斥。读期间发生了写，则需要重新读取数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">写顺序锁</span><br><span class="line">&#x2F;*写代码*&#x2F;</span><br><span class="line">释放写顺序锁</span><br></pre></td></tr></table></figure>



<h1 id="读-复制-更新"><a href="#读-复制-更新" class="headerlink" title="读-复制-更新"></a>读-复制-更新</h1><p>RCU：read-copy-update</p>
<h1 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h1><p>信号量，又名semaphore，是一种  用于同步和互斥的手段。<br>特点：睡眠锁，等待的过程不会占用CPU时间，适用于等待时间较长的临界区。<br>信号量消耗的CPU时间的地方在于使线程睡眠和唤醒线程，如果(使线程睡眠 + 唤醒线程)的CPU时间 &gt; 线程自旋等待的CPU时间，那么可以考虑使用自旋锁。<br>信号量的值可以是0，1，n。总之非负整数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">定义信号量</span><br><span class="line">初始化信号量</span><br><span class="line">获得信号量</span><br><span class="line">释放信号量</span><br></pre></td></tr></table></figure>
<p>信号量用于互斥和同步<br>互斥：<br>同步：</p>
<p><img src="7.png" alt="img"></p>
<h1 id="PV原语"><a href="#PV原语" class="headerlink" title="PV原语"></a>PV原语</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">P(S)等价于S&#x3D;S-1</span><br><span class="line">if (S&gt;&#x3D;0)</span><br><span class="line">	进程继续；</span><br><span class="line">else</span><br><span class="line">	进程进入等待队列；</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">V(S)等价于S&#x3D;S+1</span><br><span class="line">if(S&gt;0)</span><br><span class="line">	该进程被唤醒，返回调用处继续执行</span><br><span class="line">else</span><br><span class="line">	从等待队列中唤醒一等待进程</span><br></pre></td></tr></table></figure>
<p>S=0<br>P(S)则S=-1，进程等待<br>V(S)则S=0，进程等待</p>
<h1 id="信号量与自旋锁的区别"><a href="#信号量与自旋锁的区别" class="headerlink" title="信号量与自旋锁的区别"></a>信号量与自旋锁的区别</h1><p>信号量表面看和自旋锁很相似，区别在于争用自旋锁的线程会一直循环尝试获取自旋锁，而争用信号量的线程在信号量为0时，会进入睡眠，信号量可用时再被唤醒。</p>
<h1 id="计数信号量和二值信号量"><a href="#计数信号量和二值信号量" class="headerlink" title="计数信号量和二值信号量"></a>计数信号量和二值信号量</h1><p>信号量有二值信号量和计数信号量2种，其中二值信号量比较常用。</p>
<p>二值信号量：<br>表示信号量只有2个值，即0和1。信号量为1时，表示临界区可用，信号量为0时，表示临界区不可访问。<br> <br>计数信号量：初始化时把数量设为大于1的非0值<br>计数信号量有个计数值，比如计数值为5，表示同时可以有5个线程访问临界区。</p>
<h1 id="互斥体"><a href="#互斥体" class="headerlink" title="互斥体"></a>互斥体</h1><p>互斥体也是一种可以睡眠的锁，相当于二值信号量，只是提供的API更加简单，使用的场景也更严格一些，如下所示：<br>1：mutex的计数值只能为1，也就是最多只允许一个线程访问临界区<br>2：在同一个上下文中上锁和解锁，给mutex上锁者必须负责给其解锁<br>3：递归地上锁和解锁是不允许的。也就是说，你不能递归地持有同一个锁，同样你也不能再去解锁一个已经被       解开的mutex.<br>4：持有1个mutex时，进程不能退出<br>5：mutex不能在中断或者下半部中使用，也就是mutex只能在进程上下文中使用<br>6：mutex只能通过官方API来管理，不能自己写代码操作它</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">定义互斥体</span><br><span class="line">初始化互斥体</span><br><span class="line">获取互斥体</span><br><span class="line">释放互斥体</span><br></pre></td></tr></table></figure>
<p><img src="8.png" alt="img"><br>互斥体的实现依赖于自旋体，互斥体是进程级的，用于多个进程之间对资源的互斥。</p>
<h1 id="各种锁使用的场景pk"><a href="#各种锁使用的场景pk" class="headerlink" title="各种锁使用的场景pk"></a>各种锁使用的场景pk</h1><h1 id="完成量"><a href="#完成量" class="headerlink" title="完成量"></a>完成量</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/newnewman80/article/details/16112669">https://blog.csdn.net/newnewman80/article/details/16112669</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tureno/articles/6080923.html">https://www.cnblogs.com/tureno/articles/6080923.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linhaostudy/p/6670693.html">https://www.cnblogs.com/linhaostudy/p/6670693.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/edver/p/7260696.html">https://www.cnblogs.com/edver/p/7260696.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38619183/article/details/83097475">https://blog.csdn.net/qq_38619183/article/details/83097475</a></p>
<h1 id="实现设备只能被一个进程打开的3种方式"><a href="#实现设备只能被一个进程打开的3种方式" class="headerlink" title="实现设备只能被一个进程打开的3种方式"></a>实现设备只能被一个进程打开的3种方式</h1><h2 id="原子变量实现设备只能被一个进程打开"><a href="#原子变量实现设备只能被一个进程打开" class="headerlink" title="原子变量实现设备只能被一个进程打开"></a>原子变量实现设备只能被一个进程打开</h2><p>过程描述：</p>
<ol>
<li>假设线程A拿到了原子变量xxx_available，执行函数atomic_dec_and_test(&amp;xxx_available)，变量xxx_available由1减1变成了0，此时函数返回True。接着取反为FALSE，不走if{}内的内容了。执行后面打开设备的代码。</li>
<li>假设现在又线程B想要打开设备，首先它来取原子变量xxx_available，此时变量值为0，执行行函数atomic_dec_and_test(&amp;xxx_available)，变量xxx_available由0减1变成-1，此时函数返回flase，取反为true，走if{}的内容。执行函数atomic_inc(&amp;xxx_available)，于是变量xxx_available由-1加1，变成0，返回-EBUSY。</li>
<li>接着又一个线程C想打开设备，只要线程A未释放原子变量，其他线程都要经历步骤2.</li>
<li>假设线程A此刻释放原子变量，即执行atmomic_inc(&amp;xxx_available);那么，变量恢复值1.其他线程想要打开设备，将执行步骤1.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">static atomic_t xxx_available &#x3D; ATOMIC_INIT(1); &#x2F;&#x2F;定义原子变量xxx_available，并赋初值1给它。</span><br><span class="line">static int xxx_open(struct inode *inode, struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">   ...</span><br><span class="line">if(!atomic_dec_and_test(&amp;xxx_available))&#123;</span><br><span class="line">    atomic_inc(&amp;xxx_available);</span><br><span class="line">    return -EBUSY; </span><br><span class="line"> &#125;</span><br><span class="line">...&#x2F;*这里才是打开的代码段*&#x2F;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">static int xxx_release(struct inode *inode, struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">    atmomic_inc(&amp;xxx_available);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fd &#x3D; xxx_open (&quot;&#x2F;dev&#x2F;buttons&quot;, O_RDWR);</span><br><span class="line">if (fd &lt; 0)</span><br><span class="line">&#123;</span><br><span class="line">	printf(&quot;can&#39;t open!\n&quot;);</span><br><span class="line">	return -1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="自旋锁实现设备只能被一个进程打开"><a href="#自旋锁实现设备只能被一个进程打开" class="headerlink" title="自旋锁实现设备只能被一个进程打开"></a>自旋锁实现设备只能被一个进程打开</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">int xxx_count &#x3D; 0;&#x2F;&#x2F; 定义文件打开次计数</span><br><span class="line">static int xxx_open(struct inode *inode, struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">   spinlock(&amp;xxx_lock);</span><br><span class="line">    if(xxx_count)&#123; &#x2F;&#x2F;已经打开</span><br><span class="line">        spin_unlock(&amp;xxx_lock);</span><br><span class="line">        return -EBUSY;</span><br><span class="line">&#125;</span><br><span class="line">    xxx_count++;&#x2F;&#x2F;增加计数</span><br><span class="line">    spin_unlock(&amp;xxx_lock);</span><br><span class="line">    ...</span><br><span class="line">   return 0;</span><br><span class="line">&#125;</span><br><span class="line">static int xxx_release(struct inode *inode, struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    spinlock(&amp;xxx_lock);</span><br><span class="line">    xxx_count--;</span><br><span class="line">    spin_unlock(&amp;xxx_lock);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="信号量实现设备只能被一个进程打开"><a href="#信号量实现设备只能被一个进程打开" class="headerlink" title="信号量实现设备只能被一个进程打开"></a>信号量实现设备只能被一个进程打开</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static DECLARE_MUTEX(xxx_lock);</span><br><span class="line">&#x2F;*strcut semaphore sem</span><br><span class="line"> * init_MUTEX(&amp;sem);</span><br><span class="line"> * 2.6.25版本后不适用init_MUTEX,用sema_init(sem,1)代替 </span><br><span class="line">*&#x2F;</span><br><span class="line">static int xxx_open(struct inode *inode, struct file *filep)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    if(down_trylock(&amp;xxx_lock))  &#x2F;&#x2F;第一次打开获取锁，第二次打开不能获取</span><br><span class="line">    return -EBUSY;</span><br><span class="line">...</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">static int xxx_release(struct inode,struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">    up(&amp;xxx_lock);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/15/Qt2-signal-slot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/15/Qt2-signal-slot/" class="post-title-link" itemprop="url">Qt中信号与槽--窗体可视化设计篇</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-11-15 12:20:20 / 修改时间：13:49:15" itemprop="dateCreated datePublished" datetime="2020-11-15T12:20:20+08:00">2020-11-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-打开Qt-Creator，新建工程"><a href="#1-打开Qt-Creator，新建工程" class="headerlink" title="1.打开Qt Creator，新建工程"></a>1.打开Qt Creator，新建工程</h3><p><img src="1.PNG" alt="img"></p>
<p>###2.工程选择application-&gt;Qt Widgets Application</p>
<p><img src="2.PNG" alt="img"></p>
<p>###3.工程命名为QtApp，保存在路径文件夹Demo2_3中</p>
<p><img src="3.PNG" alt="img"></p>
<p>###4.编译工具勾选mingw 64 bit</p>
<p><img src="4.PNG" alt="img"></p>
<p>###5.选择基类对话框QDialog，将创建Dialog.h和Dialog.cpp。勾选Generate from，将创建Dialog.ui。</p>
<p><img src="5.png" alt="img"></p>
<p>###6.版本控制可不做选择，这里添加了git来做版本控制。按finish结束项目新建。</p>
<p><img src="6.png" alt="img"></p>
<p>###7.QtApp.pro是项目文件，Qt Creator打开QtApp.pro即打开这个项目。Dialog.ui是窗体UI文件，双击则进入Design 进行可视化设计。</p>
<p><img src="7.png" alt="img"></p>
<p>###8.下面进行UI设计，先双击.ui文件，打开窗口</p>
<p><img src="8.png" alt="img"></p>
<p>###9.先拖入容器Group Box，在该容器内再拖入3个checkBox。现在假如拖动Group Box，则3个checkbox也会跟着动。</p>
<p><img src="9.png" alt="img"></p>
<p>###10.拖入垂直布局vertical Layout，再往其中拖入3个radio button，在两两radio button之间插入一个horizontal Spacer。于是，这个3个radio button以水平等距离布局呈现。下面3个pushbutton按钮以此方式进行。</p>
<p><img src="10.png" alt="img"></p>
<p>###11.下面对各个组件进行设置：选中中间那个pushbutton按钮，修改其objectName为btnOK, text内容为“确定”。</p>
<p><img src="10-1.png" alt="img"></p>
<p>拖入plainTextEdit组件，写好text内容，修改字体大小为20.</p>
<p><img src="10-2.png" alt="img"></p>
<p>最终所以组件呈现方式：</p>
<p><img src="11.png" alt="img"></p>
<p>###12.下面进行“信号与槽”的设计，edit-&gt;edit signals/slots，进入编辑状态。</p>
<p><img src="12.png" alt="img"></p>
<p>###13.选中“确定”按钮不放，拖向空白区，会弹出连接配置。这里选择clicked()信号，accept()槽函数。</p>
<p><img src="13.png" alt="img"></p>
<p>###14.我们可以勾选“show signals and slots inherited from QWidget”来看隐藏的选项。</p>
<p><img src="14.png" alt="img"></p>
<p>在下方的singal slots edit界面可以看到刚刚为btnOK和btnClose添加的信号和槽函数。</p>
<p><img src="15.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/10/Qt3-signal-slot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/10/Qt3-signal-slot/" class="post-title-link" itemprop="url">Qt 中信号与槽--第二篇</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-10 22:27:25" itemprop="dateCreated datePublished" datetime="2020-11-10T22:27:25+08:00">2020-11-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-15 14:03:36" itemprop="dateModified" datetime="2020-11-15T14:03:36+08:00">2020-11-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>#项目程序架构<br>##项目文件组成<br>##批处理文件<br>##窗体界面定义文件<br>##窗体业务逻辑类文件<br>##应用程序主程序文件</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://queeniechen.github.io/2020/11/08/Qt1-mine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Queenie Chen">
      <meta itemprop="description" content="我叫小白，初来乍到，请多指教~">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Queenie Chen">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/08/Qt1-mine/" class="post-title-link" itemprop="url">使用Qt Create创建hello word 界面</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-08 15:20:41" itemprop="dateCreated datePublished" datetime="2020-11-08T15:20:41+08:00">2020-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-11-10 23:30:59" itemprop="dateModified" datetime="2020-11-10T23:30:59+08:00">2020-11-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文旨在介绍如何用qt create创建一个简单的界面hello word，以及阐述相关代码。</p>
<h1 id="如何创建？"><a href="#如何创建？" class="headerlink" title="如何创建？"></a>如何创建？</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>python安装</li>
<li>Qt Create安装</li>
</ol>
<h2 id="创建步骤"><a href="#创建步骤" class="headerlink" title="创建步骤"></a>创建步骤</h2><p>1.新建工程<br><img src="1.PNG" alt="img"><br><img src="2.PNG" alt="img"><br>2.拖动label和push button<br><img src="3.PNG" alt="img"><br><img src="4.PNG" alt="img"><br>3.修改label的属性<br>objectName是组件对象的名称 ，每个组件都有唯一对应的对象名称。<br><img src="5.PNG" alt="img"></p>
<p>类的继承关系：<br><img src="6.PNG" alt="img"></p>
<p>修改属性对应的值，这里改变文本显示的内容：<br><img src="7.PNG" alt="img"></p>
<p>窗体是QWidget类，其objectName是FormHello：<br><img src="8.PNG" alt="img"><br>4.保存为formhello.ui文件<br>其内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;ui version&#x3D;&quot;4.0&quot;&gt;</span><br><span class="line"> &lt;class&gt;FormHello&lt;&#x2F;class&gt;</span><br><span class="line"> &lt;widget class&#x3D;&quot;QWidget&quot; name&#x3D;&quot;FormHello&quot;&gt;</span><br><span class="line">  &lt;property name&#x3D;&quot;geometry&quot;&gt;</span><br><span class="line">   &lt;rect&gt;</span><br><span class="line">    &lt;x&gt;0&lt;&#x2F;x&gt;</span><br><span class="line">    &lt;y&gt;0&lt;&#x2F;y&gt;</span><br><span class="line">    &lt;width&gt;400&lt;&#x2F;width&gt;</span><br><span class="line">    &lt;height&gt;300&lt;&#x2F;height&gt;</span><br><span class="line">   &lt;&#x2F;rect&gt;</span><br><span class="line">  &lt;&#x2F;property&gt;</span><br><span class="line">  &lt;property name&#x3D;&quot;windowTitle&quot;&gt;</span><br><span class="line">   &lt;string&gt;Demo2_2&lt;&#x2F;string&gt;</span><br><span class="line">  &lt;&#x2F;property&gt;</span><br><span class="line">  &lt;widget class&#x3D;&quot;QPushButton&quot; name&#x3D;&quot;btnClose&quot;&gt;</span><br><span class="line">   &lt;property name&#x3D;&quot;geometry&quot;&gt;</span><br><span class="line">    &lt;rect&gt;</span><br><span class="line">     &lt;x&gt;150&lt;&#x2F;x&gt;</span><br><span class="line">     &lt;y&gt;190&lt;&#x2F;y&gt;</span><br><span class="line">     &lt;width&gt;75&lt;&#x2F;width&gt;</span><br><span class="line">     &lt;height&gt;23&lt;&#x2F;height&gt;</span><br><span class="line">    &lt;&#x2F;rect&gt;</span><br><span class="line">   &lt;&#x2F;property&gt;</span><br><span class="line">   &lt;property name&#x3D;&quot;text&quot;&gt;</span><br><span class="line">    &lt;string&gt;关闭&lt;&#x2F;string&gt;</span><br><span class="line">   &lt;&#x2F;property&gt;</span><br><span class="line">  &lt;&#x2F;widget&gt;</span><br><span class="line">  &lt;widget class&#x3D;&quot;QLabel&quot; name&#x3D;&quot;LabelHello&quot;&gt;</span><br><span class="line">   &lt;property name&#x3D;&quot;geometry&quot;&gt;</span><br><span class="line">    &lt;rect&gt;</span><br><span class="line">     &lt;x&gt;120&lt;&#x2F;x&gt;</span><br><span class="line">     &lt;y&gt;70&lt;&#x2F;y&gt;</span><br><span class="line">     &lt;width&gt;181&lt;&#x2F;width&gt;</span><br><span class="line">     &lt;height&gt;31&lt;&#x2F;height&gt;</span><br><span class="line">    &lt;&#x2F;rect&gt;</span><br><span class="line">   &lt;&#x2F;property&gt;</span><br><span class="line">   &lt;property name&#x3D;&quot;font&quot;&gt;</span><br><span class="line">    &lt;font&gt;</span><br><span class="line">     &lt;pointsize&gt;12&lt;&#x2F;pointsize&gt;</span><br><span class="line">     &lt;weight&gt;75&lt;&#x2F;weight&gt;</span><br><span class="line">     &lt;bold&gt;true&lt;&#x2F;bold&gt;</span><br><span class="line">    &lt;&#x2F;font&gt;</span><br><span class="line">   &lt;&#x2F;property&gt;</span><br><span class="line">   &lt;property name&#x3D;&quot;text&quot;&gt;</span><br><span class="line">    &lt;string&gt;Hello，Qt Creator!&lt;&#x2F;string&gt;</span><br><span class="line">   &lt;&#x2F;property&gt;</span><br><span class="line">  &lt;&#x2F;widget&gt;</span><br><span class="line"> &lt;&#x2F;widget&gt;</span><br><span class="line"> &lt;resources&#x2F;&gt;</span><br><span class="line"> &lt;connections&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;ui&gt;</span><br></pre></td></tr></table></figure>
<p>5.将.ui文件编译成.py文件<br>命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyuic5 -o ui_formhello.py formhello.ui</span><br></pre></td></tr></table></figure>

<p>上述命令可写成.bat文件，方便执行</p>
<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line"># Form implementation generated from reading ui file &#39;formhello.ui&#39;</span><br><span class="line">#</span><br><span class="line"># Created by: PyQt5 UI code generator 5.13.2</span><br><span class="line">#</span><br><span class="line"># WARNING! All changes made in this file will be lost!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from PyQt5 import QtCore, QtGui, QtWidgets</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Ui_FormHello(object):</span><br><span class="line">    def setupUi(self, FormHello):</span><br><span class="line">        FormHello.setObjectName(&quot;FormHello&quot;)</span><br><span class="line">        FormHello.resize(400, 300)</span><br><span class="line">        self.btnClose &#x3D; QtWidgets.QPushButton(FormHello)</span><br><span class="line">        self.btnClose.setGeometry(QtCore.QRect(150, 190, 75, 23))</span><br><span class="line">        self.btnClose.setObjectName(&quot;btnClose&quot;)</span><br><span class="line">        self.LabelHello &#x3D; QtWidgets.QLabel(FormHello)</span><br><span class="line">        self.LabelHello.setGeometry(QtCore.QRect(120, 70, 181, 31))</span><br><span class="line">        font &#x3D; QtGui.QFont()</span><br><span class="line">        font.setPointSize(12)</span><br><span class="line">        font.setBold(True)</span><br><span class="line">        font.setWeight(75)</span><br><span class="line">        self.LabelHello.setFont(font)</span><br><span class="line">        self.LabelHello.setObjectName(&quot;LabelHello&quot;)</span><br><span class="line"></span><br><span class="line">        self.retranslateUi(FormHello)</span><br><span class="line">        QtCore.QMetaObject.connectSlotsByName(FormHello)</span><br><span class="line"></span><br><span class="line">    def retranslateUi(self, FormHello):</span><br><span class="line">        _translate &#x3D; QtCore.QCoreApplication.translate</span><br><span class="line">        FormHello.setWindowTitle(_translate(&quot;FormHello&quot;, &quot;Demo2_2&quot;))</span><br><span class="line">        self.btnClose.setText(_translate(&quot;FormHello&quot;, &quot;关闭&quot;))</span><br><span class="line">        self.LabelHello.setText(_translate(&quot;FormHello&quot;, &quot;Hello，Qt Creator!&quot;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>6.编写appMain1.py，使用类Ui_FormHello创建GUI应用程序基本框架</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import sys</span><br><span class="line">sys.path.append(r&quot;D:\MyLearing\QtProj\Demo2_2&quot;)</span><br><span class="line">from PyQt5 import QtWidgets</span><br><span class="line">from ui_formhello import Ui_FormHello</span><br><span class="line"></span><br><span class="line">app &#x3D; QtWidgets.QApplication(sys.argv)</span><br><span class="line">baseWidget &#x3D;QtWidgets.QWidget()</span><br><span class="line"></span><br><span class="line">ui &#x3D; Ui_FormHello()</span><br><span class="line">ui.setupUi(baseWidget)</span><br><span class="line"></span><br><span class="line">baseWidget.show()</span><br><span class="line">## ui.LabHello.setText(&quot;这样可修改窗体上标签的文字&quot;)</span><br><span class="line"></span><br><span class="line">sys.exit(app.exec_())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>运行<br>命令：<br><img src="9.PNG" alt="img"></li>
</ol>
<p><img src="10.PNG" alt="img"><br>结果：<br><img src="11.PNG" alt="img"></p>
<h1 id="代码阐述"><a href="#代码阐述" class="headerlink" title="代码阐述"></a>代码阐述</h1><h2 id="appMain1-py"><a href="#appMain1-py" class="headerlink" title="appMain1.py"></a>appMain1.py</h2><p>通过拖动组件，设置好属性及布局后的界面，会自动生成formhello.ui文件。再通过命令将窗体文件formhello.ui编译转换为类定义文件ui_formhello.py，通过编写appMain1.py文件来调用ui_formhello.py中的类Ui_FormHello，从而创建GUI应用程序。</p>
<p>1.模块导入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import sys </span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">导入模块sys。这种直接import模块的方法，在后面如需使用该模块内的属性和方法时，必须使用   模块名.属性   和   模块名.方法   来进行调用</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">sys.path.append(r&quot;D:\MyLearing\QtProj\Demo2_2&quot;)</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">python解释器的搜索路径存放在sys.path中，当我们新添模块时，需要自己将搜索目录添加进去</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">from PyQt5 import QtWidgets</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">可直接使用模块QtWidgets内的属性和方法，但是若遇上该模块内包含的属性和方法与咱自定义的模块同名时就会导致冲突，所以一般尽可能直接导入模块，避免debug</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">from ui_formhello import Ui_FormHello</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">从文件ui_formhello.py中导入模块Ui_FormHello</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>2.先创建应用程序实例，再创建窗体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app &#x3D; QtWidgets.QApplication(sys.argv)</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">首先使用模块QtWidgets中的类QApplication来创建应用程序实例app</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">baseWidget &#x3D;QtWidgets.QWidget()</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">使用模块QtWidgets中的类QWidget，创建了QWidget类的对象baseWidget，目前baseWidget是没有任何设置的QWidget类窗体</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>3.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ui &#x3D; Ui_FormHello()</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">创建了一个Ui_FormHello类对象ui</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">ui.setupUi(baseWidget)</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">baseWidget作为QWidget类窗体传入给函数setupUi，setupUi只创建窗体上其他组件。</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>4.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">baseWidget.show()</span><br><span class="line">## ui.LabHello.setText(&quot;这样可修改窗体上标签的文字&quot;)</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">ui是Ui_FormHello类的实例对象，窗体上所有界面组件都是ui的实例对象。</span><br><span class="line">baseWidget虽然是窗体，是LabHello的父容器，但baseWidget并没有定义公共属性LabHello。</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Queenie Chen</p>
  <div class="site-description" itemprop="description">我叫小白，初来乍到，请多指教~</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Queenie Chen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
